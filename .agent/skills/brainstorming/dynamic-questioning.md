# 动态提问生成 (Dynamic Question Generation)

> **原则 (PRINCIPLE):** 提问的目的不是为了收集数据，而是为了**揭示架构层面的后果**。
>
> 每一个提问都必须关联到一个具体的实现决策，且该决策会影响成本、复杂度或时间线。

---

## 🧠 核心原则

### 1. 提问揭示后果

一个好的问题不是问“您想要什么颜色？”，而是：

```markdown
❌ 错误提问: "您想要哪种认证方式？"
✅ 正确提问: "用户应该通过 邮箱/密码 还是 社交登录 进行注册？"

影响:

- 邮箱/密码 → 需要密码重置逻辑、哈希加密存储、2FA (双因素认证) 基础设施
- 社交登录 → 涉及 OAuth 提供商、用户资料映射，但自主控制力较弱

权衡: 安全性 vs 开发时间 vs 用户流失率
```

### 2. 背景先行 (Context Before Content)

首先要理解这个请求属于哪种**背景 (Context)**：

| 背景                    | 提问焦点                                 |
| ----------------------- | ---------------------------------------- |
| **新项目 (Greenfield)** | 基础设施决策：技术栈、托管方式、规模规划 |
| **功能新增**            | 集成点、现有模式、破坏性变更的可能性     |
| **重构 (Refactor)**     | 为何重构？性能？可维护性？现有什么问题？ |
| **调试 (Debug)**        | 现象 → 根本原因 → 复现路径               |

### 3. 最小可行提问 (Minimum Viable Questions)

**原则:** 每个问题都必须能消除实现路径上的一个分叉。

```
提问前:
├── 路径 A: 执行 X (5 分钟)
├── 路径 B: 执行 Y (15 分钟)
└── 路径 C: 执行 Z (1 小时)

提问后:
└── 路径已确认: 执行 X (5 分钟)
```

如果一个提问不能减少实现路径的选择范围 → **请删掉它**。

### 4. 生成数据而非假设

```markdown
❌ 错误假设: "用户可能想用 Stripe 处理支付"
✅ 正确提问: "哪种支付服务商符合您的需求？"

Stripe → 文档最全, 2.9% + $0.30, 核心市场在欧美
LemonSqueezy → 代收代缴全球税费, 5% + $0.50, 全球化支持好
Paddle → 价格较复杂, 处理欧盟增值税, 偏向企业级
```

---

## 📋 提问生成算法 (Question Generation Algorithm)

```
输入: 用户请求 + 背景 (新项目/功能/重构/调试)
│
├── 步骤 1: 解析请求
│   ├── 提取领域 (电商, 认证, 实时通讯, CMS 等)
│   ├── 提取功能 (显式的和隐喻的)
│   └── 提取规模指标 (用户量, 数据量, 频率)
│
├── 步骤 2: 识别决策点
│   ├── 编写代码前“必须”决定什么？ (阻塞性决策)
│   ├── 哪些决策可以延后？ (可延迟决策)
│   └── 哪些具有“架构性”影响？ (高杠杆决策)
│
├── 步骤 3: 生成问题 (按优先级排序)
│   ├── P0: 阻塞性决策 (不回答则无法继续)
│   ├── P1: 高杠杆决策 (影响 >30% 的实现工作)
│   ├── P2: 中等杠杆 (影响特定功能)
│   └── P3: 可选 (边缘情况, 优化项)
│
└── 步骤 4: 格式化每个提问
    ├── 内容: 清晰的问题
    ├── 理由: 对实现的影响
    ├── 选项: 权衡方案 (不只是 A vs B)
    └── 默认值: 如果用户不回答，我们会怎么做
```

---

## 🎯 特定领域问题库

### 电子商务 (E-Commerce)

| 提问                         | 为什么这很重要                              | 权衡方案                      |
| ---------------------------- | ------------------------------------------- | ----------------------------- |
| **是单商户还是多商户？**     | 多商户 → 需要分佣逻辑、卖家工作台、分账支付 | +收入, -开发复杂度            |
| **是否需要库存跟踪？**       | 需要库存表、预留逻辑、低库存警报            | +准确度, -开发时间            |
| **是数字产品还是实物产品？** | 数字 → 涉及下载链接, 无物流                 | 实物 → 涉及物流 API, 快递跟踪 |
| **订阅制还是单次购买？**     | 订阅 → 涉及循环计费、催收、按比例退款逻辑   | +长期收入, -开发复杂度        |

### 身份验证 (Authentication)

| 提问                                | 为什么这很重要                               | 权衡方案               |
| ----------------------------------- | -------------------------------------------- | ---------------------- |
| **是否需要社交登录？**              | 引入 OAuth 提供商 vs 编写密码重置等基础设施  | +UX体验, -自主控制权   |
| **是否需要基于角色的权限 (RBAC)？** | 需要 RBAC 表、策略执行逻辑、管理员 UI        | +安全性, -开发时间     |
| **是否需要双因素认证 (2FA)？**      | 涉及 TOTP/SMS 基础设施、备份验证码、恢复流程 | +安全性, -用户注册损耗 |
| **是否需要邮件验证？**              | 涉及验证令牌、邮件服务、重发逻辑             | +安全性, -注册流失率   |

### 实时通讯 (Real-time)

| 提问                                    | 为什么这很重要                                                         | 权衡方案                |
| --------------------------------------- | ---------------------------------------------------------------------- | ----------------------- |
| **采用 WebSocket 还是轮询 (Polling)？** | WS → 涉及服务器扩展、连接管理                                          | 轮询 → 更简单，但延迟高 |
| **预期并发用户数？**                    | <100 → 单机即可, >1000 → 需要 Redis 发布/订阅, >10k → 需要专用基础架构 | +可扩展性, -开发复杂度  |
| **消息是否需要持久化？**                | 涉及历史消息表、存储成本、分页查询                                     | +用户体验, -存储成本    |
| **是瞬时消息还是持久消息？**            | 瞬时 → 仅存储于内存, 持久 → 发送前先入库                               | +可靠性, -延迟增加      |

### 内容管理 (Content/CMS)

| 提问                                  | 为什么这很重要                           | 权衡方案                                |
| ------------------------------------- | ---------------------------------------- | --------------------------------------- |
| **采用富文本还是 Markdown？**         | 富文本 → 涉及内容清洗、XSS 风险          | Markdown → 简单，无所见即所得 (WYSIWYG) |
| **是否需要 草稿/发布 工作流？**       | 涉及状态字段、定时任务、版本控制         | +内容管控, -开发复杂度                  |
| **如何处理媒体文件？**                | 涉及上传端点、存储、内容优化 (裁剪/压缩) | +功能丰富, -开发时间                    |
| **是否需要多语言 (Multi-language)？** | 涉及 i18n 表、翻译 UI、回退逻辑          | +触达范围, -开发复杂度                  |

---

## 📐 动态提问模板

```markdown
基于您对 [领域] [功能] 的需求：

## 🔴 关键决策 (阻塞性决策)

### 1. **[决策点]**

**提问:** [清晰、具体的提问]

**为什么这很重要:**

- [解释架构层面的后果]
- [影响: 成本 / 复杂度 / 时间线 / 规模]

**候选项:**
| 选项 | 优点 | 缺点 | 最适用场景 |
|--------|------|------|----------|
| A | [优势] | [劣势] | [用例] |
| B | [优势] | [劣势] | [用例] |

**如果不指定:** [默认选择 + 理由]

---

## 🟡 高杠杆决策 (影响实现工作)

### 2. **[决策点]**

[同上格式]

---

## 🟢 可选决策 (边缘情况)

### 3. **[决策点]**

[同上格式]
```

---

## 🔄 迭代式提问 (Iterative Questioning)

### 第一阶段 (3-5 个问题)

专注于 **阻塞性决策**。在获得答案前不要继续。

### 第二阶段 (初步实现后)

随着模式的显现，询问：

- “这个功能隐含了 [X] 的需求。我们现在处理 [边缘情况] 还是先延后？”
- “我们目前使用了 [模式 A]。[功能 B] 是否也应遵循同样的模式？”

### 第三阶段 (优化阶段)

当功能可以正常运行后：

- “[X] 处存在性能瓶颈。现在优化还是目前可以接受？”
- “[Y] 处是否需要为了可维护性进行重构，或者直接发布？”

---

## 🎭 示例：全流程提问生成

```
用户请求: "做一个 Instagram 克隆版"

步骤 1: 解析
├── 领域: 社交媒体
├── 功能: 照片分享, 互动 (点赞/评论), 用户资料
├── 隐含需求: 动态流 (Feed), 关注功能, 身份验证
└── 规模: 潜在的高并发 (社交应用易病毒式传播)

步骤 2: 决策点
├── 阻塞性: 存储策略, 认证方式, 动态流类型
├── 高杠杆: 实时通知, 数据模型复杂度
└── 可延迟: 数据分析, 高级搜索, 短视频

步骤 3: 生成提问 (优先级)

P0 (阻塞):
1. 存储策略 → 影响架构、成本、速度
2. 动态流算法 → 影响数据库查询、复杂度
3. 认证方式 → 影响开发时间、体验、安全

P1 (高杠杆):
4. 实时通知 → WebSocket vs 轮询
5. 媒体处理 → 客户端 vs 服务端优化

P2 (可延迟):
6. 故事/短视频 → 功能蔓延严重，延至 v2
7. 私信/聊天 → 独立的子系统，延至 v2

步骤 4: 格式化输出
```

---

## 📊 生成的输出示例 (Generated Output Example)

```
针对您的 Instagram 克隆版需求：

## 🔴 关键决策 (不回答则无法继续)

### 1. **照片存储策略**

**提问:** 用户照片将存储并托管在何处？

**为什么这很重要:**
- 影响: 每月托管成本、页面加载速度、CDN 复杂度
- 高流量社交应用示例: 1000 用户 × 10 张图 × 2MB = 20GB 存储需求

**候选项:**
| 选项 | 成本 | 速度 | 复杂度 | 最适用场景 |
|--------|------|-------|------------|----------|
| **Cloudinary** | $89/月 (25GB) | 极快 (自带 CDN) | 低 | MVP, 快速上线 |
| **AWS S3 + CloudFront** | $0.023/GB | 极快 (CDN) | 中 | 生产环境, 成本优化 |
| **Supabase Storage** | 免费额度 1GB | 中等 | 低 | 小规模, 简单应用 |
| **本地存储** | 仅服务器成本 | 慢 | 低 | 仅限开发调试 |

**如果不指定:** 默认选择 Cloudinary (均衡了 MVP 开发效率)

---

### 2. **动态流 (Feed) 算法选择**

**提问:** 主动态流应如何运作？

**为什么这很重要:**
- 影响: 数据库查询复杂度、缓存策略、开发时间
- 算法推荐流需要机器学习基础架构和排序信号支持

**候选项:**
| 选项 | 复杂度 | 数据库影响 | 最适用场景 |
|--------|------------|-----------------|----------|
| **时间轴 (倒序)** | 低 | 简单查询 | 早期阶段, 信息透明 |
| **仅关注者可见** | 中 | 关联查询 + 分页 | 大多数社交应用的基础 |
| **算法推荐** | 高 | 预计算动态流表 | 专业的 Instagram 竞品 |

**如果不指定:** 默认选择 “仅关注者可见” (社交应用的平衡选择)

---

### 3. **身份验证方案**

**提问:** 用户如何注册和登录？

**为什么这很重要:**
- 影响: 开发时间 (2-5 小时), 安全等级, 用户体验摩擦力

**候选项:**
| 选项 | 开发耗时 | 安全性 | 用户体验 | 最适用场景 |
|--------|----------|----------|-----|----------|
| **邮箱/密码** | 4-5 小时 | 高 (若加 2FA) | 中 | 需要完全自主控制 |
| **仅限社交登录** | 1-2 小时 | 取决于提供商 | 极佳 | B2C 应用, 快速获客 |
| **魔术链接 (Email)** | 2-3 小时 | 中 | 较好 | 关注安全, 无需密码 |
| **Clerk/Auth0** | 1 小时 | 极高 | 极佳 | 追求最快上线速度 |

**如果不指定:** 默认选择 Clerk (对 MVP 而言最快)

---

## 🟡 高杠杆决策 (影响架构)

### 4. **实时通知**

**提问:** 用户在获得点赞/评论时是否需要“即时”通知？

**为什么这很重要:**
- WebSocket 会增加基础设施复杂度 (扩展时需要 Redis 发布/订阅)
- 轮询更简单但延迟较高

**候选项:**
| 选项 | 复杂度 | 扩展成本 | 最适用场景 |
|--------|------------|------------|----------|
| **WebSocket + Redis** | 高 | $10+/月 | >1000 并发用户 |
| **长轮询 (30s)** | 低 | 数据库查询开销 | <1000 用户 |
| **无实时需求** | 无 | 无 | MVP 阶段, 先行验证 |

**如果不指定:** 默认选择 “长轮询” (在验证需求前保持简单)

---

## 🟢 优化/次要决策 (可延至 v2)

### 5. **视频/短视频支持**
- 复杂度极高 (涉及视频转码、流媒体分发、基础设施)
- **建议**: 首发仅限照片，验证完核心模式后再增加视频支持。

### 6. **私信/即时聊天**
- 独立的子系统 (聊天架构与动态流架构完全不同)
- **建议**: 使用 Pusher/Stream 等第三方服务，或首发版本先行略过。

---

## 📋 总结建议

| 决策点 | 推荐方案 | 如果更换方案的影响 |
|----------|----------------|------------|
| 存储策略 | Cloudinary | +3 小时配置时间 |
| 动态流 | 仅关注者可见 | +2 小时查询优化 |
| 认证方式 | Clerk | -3 小时开发时间 |
| 实时通知 | 长轮询 | +5 小时 WebSocket 开发 |
| 视频支持 | 延至 v2 | N/A |
| 私信功能 | 延至 v2 | N/A |

**预计 MVP 开发总耗时:** 按上述推荐约 15-20 小时。
```

---

## 🎯 原则复盘

1. **每一个提问 = 一个架构决策** → 提问不是为了填表格。
2. **展示权衡方案** → 让用户理解决策的后果。
3. **阻塞性决策优先** → 保证项目能够立即启动。
4. **提供默认值** → 即使用户暂无想法，我们也能依据最佳实践推进。
5. **领域感知** → 电商类提问 ≠ 认证类提问 ≠ 实时通讯类提问。
6. **迭代式演进** → 随着实现过程中模式的显现，再追加更细致的提问。
7. **与调试关联**: 当问题聚焦故障排查时，可把动态提问作为 `/debug` 的前置澄清步骤。
