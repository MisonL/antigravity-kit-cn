---
name: server-management
description: 服务器管理原则、进程监控与扩缩容决策
allowed-tools: Read, Write, Edit, Glob, Grep, Bash
---

# Server Management - 服务器管理

> 生产运维的服务器管理原则。
> **学会思考，而不是死记命令。**

---

## 1. 进程管理原则 (Process Management Principles)

### 工具选择

| 场景             | 工具                     |
| ---------------- | ------------------------ |
| **Node.js 应用** | PM2 (集群, 重载)         |
| **任何应用**     | systemd (Linux 原生)     |
| **容器**         | Docker/Podman            |
| **编排**         | Kubernetes, Docker Swarm |

### 进程管理目标

| 目标                                  | 含义              |
| ------------------------------------- | ----------------- |
| **崩溃重启 (Restart on crash)**       | 自动恢复          |
| **零停机重载 (Zero-downtime reload)** | 无服务中断        |
| **集群 (Clustering)**                 | 利用所有 CPU 核心 |
| **持久化 (Persistence)**              | 重启后存活        |

---

## 2. 监控原则 (Monitoring Principles)

### 监控什么

| 类别                      | 关键指标               |
| ------------------------- | ---------------------- |
| **可用性 (Availability)** | 正常运行时间, 健康检查 |
| **性能 (Performance)**    | 响应时间, 吞吐量       |
| **错误 (Errors)**         | 错误率, 类型           |
| **资源 (Resources)**      | CPU, 内存, 磁盘        |

### 告警严重性策略

| 级别         | 响应     |
| ------------ | -------- |
| **Critical** | 立即行动 |
| **Warning**  | 尽快调查 |
| **Info**     | 每日审查 |

### 监控工具选择

| 需求         | 选项                 |
| ------------ | -------------------- |
| 简单/免费    | PM2 metrics, htop    |
| 全面可观测性 | Grafana, Datadog     |
| 错误追踪     | Sentry               |
| 正常运行时间 | UptimeRobot, Pingdom |

---

## 3. 日志管理原则 (Log Management Principles)

### 日志策略

| 日志类型     | 目的       |
| ------------ | ---------- |
| **应用日志** | 调试, 审计 |
| **访问日志** | 流量分析   |
| **错误日志** | 问题检测   |

### 日志原则

1. **轮转日志** 以防止磁盘填满
2. **结构化日志** (JSON) 以便解析
3. **适当的级别** (error/warn/info/debug)
4. **无敏感数据** 在日志中

---

## 4. 扩缩容决策 (Scaling Decisions)

### 何时扩缩容

| 症状     | 解决方案                     |
| -------- | ---------------------------- |
| 高 CPU   | 增加实例 (水平)              |
| 高内存   | 增加 RAM 或修复泄漏          |
| 响应慢   | 先分析 (Profile)，然后扩缩容 |
| 流量尖峰 | 自动扩缩容                   |

### 扩缩容策略

| 类型                  | 何时使用         |
| --------------------- | ---------------- |
| **垂直 (Vertical)**   | 快速修复, 单实例 |
| **水平 (Horizontal)** | 可持续, 分布式   |
| **自动 (Auto)**       | 可变流量         |

---

## 5. 健康检查原则 (Health Check Principles)

### 什么是健康

| 检查             | 含义           |
| ---------------- | -------------- |
| **HTTP 200**     | 服务响应中     |
| **数据库已连接** | 数据可访问     |
| **依赖 OK**      | 外部服务可达   |
| **资源 OK**      | CPU/内存未耗尽 |

### 健康检查实现

- 简单: 仅返回 200
- 深度: 检查所有依赖
- 基于负载均衡器需求选择

---

## 6. 安全原则 (Security Principles)

| 领域       | 原则                |
| ---------- | ------------------- |
| **访问**   | 仅 SSH 密钥, 无密码 |
| **防火墙** | 仅开放所需端口      |
| **更新**   | 定期安全补丁        |
| **密钥**   | 环境变量, 不是文件  |
| **审计**   | 记录访问和更改      |

---

## 7. 故障排除优先级 (Troubleshooting Priority)

当出问题时：

1. **检查是否在运行** (进程状态)
2. **检查日志** (错误消息)
3. **检查资源** (磁盘, 内存, CPU)
4. **检查网络** (端口, DNS)
5. **检查依赖** (数据库, API)

---

## 8. 反模式 (Anti-Patterns)

| ❌ 不要 (Don't) | ✅ 要 (Do)       |
| --------------- | ---------------- |
| 以 root 运行    | 使用非 root 用户 |
| 忽略日志        | 设置日志轮转     |
| 跳过监控        | 从第一天开始监控 |
| 手动重启        | 自动重启配置     |
| 无备份          | 定期备份计划     |

---

> **记住：** 一个管理良好的服务器是无聊的。这就是目标。
