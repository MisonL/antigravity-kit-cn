---
name: server-management
description: 服务器管理原则、进程监控与扩缩容决策。教导思考而非指令。
allowed-tools: Read, Write, Edit, Glob, Grep, Bash
---

# 服务器管理 (Server Management)

> 用于生产环境运维的服务器管理原则。
> **学会思考，而不是死记命令。**

---

## 1. 进程管理原则 (Process Management Principles)

### 工具选择

| 场景                     | 工具                     |
| ------------------------ | ------------------------ |
| **Node.js 应用**         | PM2 (集群, 重载)         |
| **通用应用**             | systemd (Linux 原生)     |
| **容器 (Containers)**    | Docker / Podman          |
| **编排 (Orchestration)** | Kubernetes, Docker Swarm |

### 进程管理目标

| 目标                  | 含义                     |
| --------------------- | ------------------------ |
| **崩溃自动重启**      | 自动恢复 (Auto-recovery) |
| **零停机重载**        | 无服务中断               |
| **集群 (Clustering)** | 充分利用所有 CPU 核心    |
| **持久化**            | 确保服务器重启后依然存活 |

---

## 2. 监控原则 (Monitoring Principles)

### 监控对象

| 类别       | 关键指标                    |
| ---------- | --------------------------- |
| **可用性** | 运行时间 (Uptime), 健康检查 |
| **性能**   | 响应时间, 吞吐量            |
| **错误**   | 错误率, 错误类型            |
| **资源**   | CPU, 内存, 磁盘             |

### 警报优先级策略

| 级别                | 响应方式     |
| ------------------- | ------------ |
| **紧急 (Critical)** | 立即采取行动 |
| **警告 (Warning)**  | 尽快调查     |
| **信息 (Info)**     | 每日审查     |

### 监控工具选择

| 需求        | 备选方案             |
| ----------- | -------------------- |
| 简单 / 免费 | PM2 指标, htop       |
| 全方位观测  | Grafana, Datadog     |
| 错误追踪    | Sentry               |
| 运行探测    | UptimeRobot, Pingdom |

---

## 3. 日志管理原则 (Log Management Principles)

### 日志策略

| 日志类型     | 用途       |
| ------------ | ---------- |
| **应用日志** | 调试、审计 |
| **访问日志** | 流量分析   |
| **错误日志** | 问题检测   |

### 日志原则

1. **日志轮转 (Rotate logs)** 以防止磁盘空间不足
2. **结构化日志 (Structured logging)**（如 JSON）以便于解析
3. **合适的级别**（错误/警告/信息/调试）
4. **禁止** 在日志中包含敏感数据

---

## 4. 扩缩容决策 (Scaling Decisions)

### 何时进行扩缩容

| 症状         | 解决方案                           |
| ------------ | ---------------------------------- |
| CPU 占用率高 | 增加实例（水平扩展）               |
| 内存占用率高 | 增加内存 (RAM) 或修复泄漏          |
| 响应慢       | 先进行性能分析 (Profile)，再做扩容 |
| 流量激增     | 自动扩缩容 (Auto-scaling)          |

### 扩缩容策略

| 类型                  | 使用场景             |
| --------------------- | -------------------- |
| **垂直 (Vertical)**   | 快速修复，单实例提升 |
| **水平 (Horizontal)** | 可持续、分布式       |
| **自动 (Auto)**       | 应对波动的流量       |

---

## 5. 健康检查原则 (Health Check Principles)

### 什么是“健康”

| 检查项           | 含义           |
| ---------------- | -------------- |
| **HTTP 200**     | 服务有响应     |
| **数据库已连接** | 数据可正常访问 |
| **依赖正常**     | 外部服务可达   |
| **资源充裕**     | CPU/内存未耗尽 |

### 健康检查实现

- 简单实现：仅返回 200 状态码
- 深度检查：检查所有下游依赖
- 根据负载均衡器 (LB) 的需求进行选择

---

## 6. 安全原则 (Security Principles)

| 领域               | 原则                        |
| ------------------ | --------------------------- |
| **访问控制**       | 仅限 SSH 密钥登录，禁止密码 |
| **防火墙**         | 仅开放必要的端口            |
| **更新**           | 定期安装安全补丁            |
| **机密 (Secrets)** | 使用环境变量，而非文件存储  |
| **审计**           | 记录访问与变更日志          |

---

## 7. 故障排查优先级 (Troubleshooting Priority)

当出现问题时：

1. **检查是否在运行** (进程状态)
2. **检查日志** (错误消息)
3. **检查资源** (磁盘、内存、CPU)
4. **检查网络** (端口、DNS)
5. **检查依赖** (数据库、API)

---

## 8. 反模式 (Anti-Patterns)

| ❌ 不要 (Don't)  | ✅ 要 (Do)         |
| ---------------- | ------------------ |
| 以 root 身份运行 | 使用非 root 用户   |
| 忽略日志         | 设置日志轮转       |
| 跳过监控         | 从第一天就开始监控 |
| 手动重启         | 配置自动重启       |
| 没有备份         | 制定定期的备份计划 |

---

> **记住：** 一台被良好管理的服务器是“枯燥”的。这正是我们要实现的目标。
