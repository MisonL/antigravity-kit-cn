---
name: tdd-workflow
description: 测试驱动开发 (TDD) 工作流原则。红-绿-重构循环。
allowed-tools: Read, Write, Edit, Glob, Grep, Bash
---

# TDD 工作流 (TDD Workflow)

> 先写测试，后写代码。

---

## 1. TDD 循环 (The TDD Cycle)

```
🔴 变红 (RED) → 编写一个失败的测试
     ↓
🟢 变绿 (GREEN) → 编写最精简的代码使测试通过
     ↓
🔵 重构 (REFACTOR) → 优化代码质量
     ↓
    重复上述步骤...
```

---

## 2. TDD 三法则 (The Three Laws of TDD)

1. 除非是为了让一个失败的测试通过，否则不允许编写任何生产代码。
2. 只要足以证明失败，就不要编写更多的测试代码。
3. 只要足以让测试通过，就不要编写更多的生产代码。

---

## 3. 变红 (RED) 阶段原则

### 编写内容

| 关注点   | 示例 (Example)                                             |
| -------- | ---------------------------------------------------------- |
| 行为     | “应该能让两个数字相加 (should add two numbers)”            |
| 边缘情况 | “应该能处理空输入 (should handle empty input)”             |
| 错误状态 | “遇到非法数据时应抛出异常 (should throw for invalid data)” |

### 变红阶段规则

- 测试必须先失败
- 测试名称应描述预期行为
- 每个测试（理想情况下）仅包含一个断言 (Assertion)

---

## 4. 变绿 (GREEN) 阶段原则

### 最精简代码 (Minimum Code)

| 原则                          | 含义                                        |
| ----------------------------- | ------------------------------------------- |
| **YAGNI**                     | 你以后才不需要它 (You Aren't Gonna Need It) |
| **最简实现 (Simplest thing)** | 编写能让测试通过的最少代码                  |
| **不要过早优化**              | 只要能跑通就行                              |

### 变绿阶段规则

- 不要编写多余的代码
- 暂不进行优化
- 仅仅为了通过测试，不多写一行

---

## 5. 重构 (REFACTOR) 阶段原则

### 改进内容

| 领域     | 采取行动     |
| -------- | ------------ |
| 重复代码 | 提炼公共代码 |
| 命名     | 使意图清晰   |
| 结构     | 优化组织结构 |
| 复杂度   | 简化逻辑     |

### 重构规则

- 确保所有测试依然处于“变绿”状态
- 进行微小的增量变更
- 每次重构后都要进行提交 (Commit)

---

## 6. AAA 模式

每个测试都应遵循：

| 步骤               | 目的         |
| ------------------ | ------------ |
| **编排 (Arrange)** | 准备测试数据 |
| **执行 (Act)**     | 运行待测代码 |
| **断言 (Assert)**  | 验证预期结果 |

---

## 7. 何时使用 TDD

| 场景               | TDD 的价值                     |
| ------------------ | ------------------------------ |
| 新功能开发         | 高                             |
| 错误修复 (Bug fix) | 高（先写测试）                 |
| 复杂逻辑           | 高                             |
| 探索性尝试         | 低（先做实验/Spike，再转 TDD） |
| UI 布局调整        | 低                             |

---

## 8. 测试优先级

| 优先级 | 测试类型              |
| ------ | --------------------- |
| 1      | 正常路径 (Happy path) |
| 2      | 错误场景              |
| 3      | 边缘情况              |
| 4      | 性能表现              |

---

## 9. 反模式 (Anti-Patterns)

| ❌ 不要 (Don't)  | ✅ 要 (Do)             |
| ---------------- | ---------------------- |
| 跳过变红阶段     | 必须亲眼看到测试失败   |
| 写完代码后补测试 | 先写测试，再写代码     |
| 初始实现过度设计 | 保持简单               |
| 编写多个断言     | 每个测试只针对一个行为 |
| 测试实现细节     | 测试行为表现           |

---

## 10. AI 辅助下的 TDD

### 多智能体 (Multi-Agent) 模式

| 智能体   | 角色                       |
| -------- | -------------------------- |
| 智能体 A | 编写失败的测试（变红）     |
| 智能体 B | 实现功能使测试通过（变绿） |
| 智能体 C | 进行优化（重构）           |

---

> **记住：** 测试即规范 (Specification)。如果你写不出测试，说明你还没理解透彻需求。
