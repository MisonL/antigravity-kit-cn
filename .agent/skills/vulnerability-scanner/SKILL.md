---
name: vulnerability-scanner
description: 漏洞分析原则、OWASP Top 10 与供应链安全
allowed-tools: Read, Glob, Grep, Bash
---

# 漏洞扫描器 (Vulnerability Scanner)

> 像攻击者一样思考，像专家一样防守。洞察 2025 年威胁全景。

## 🔧 运行脚本 (Runtime Scripts)

**执行以下脚本进行自动化验证：**

| 脚本                       | 用途                 | 用法                                         |
| -------------------------- | -------------------- | -------------------------------------------- |
| `scripts/security_scan.py` | 验证已应用的安全原则 | `python scripts/security_scan.py <项目路径>` |

## 📋 参考文件

| 文件                           | 用途                                       |
| ------------------------------ | ------------------------------------------ |
| [checklists.md](checklists.md) | OWASP Top 10、认证、API 及数据保护检查清单 |

---

## 1. 安全专家心态 (Security Expert Mindset)

### 核心原则

| 原则                             | 应用                               |
| -------------------------------- | ---------------------------------- |
| **假设已被入侵 (Assume Breach)** | 假设攻击者已经在内部，据此进行设计 |
| **零信任 (Zero Trust)**          | 永不信任，始终验证                 |
| **纵深防御 (Defense in Depth)**  | 多层防护，不存在单点故障           |
| **最小特权 (Least Privilege)**   | 仅授予执行任务所需的最小访问权限   |
| **安全失效 (Fail Secure)**       | 出错时，默认拒绝访问               |

### 威胁建模 (Threat Modeling) 提问

在扫描之前，请先思考：

1. 我们正在保护什么？（资产）
2. 谁会发起攻击？（威胁主体）
3. 他们会如何攻击？（攻击向量）
4. 影响是什么？（业务风险）

---

## 2. OWASP Top 10:2025

### 风险类别

| 级别    | 类别             | 思考点                                |
| ------- | ---------------- | ------------------------------------- |
| **A01** | 失效的访问控制   | 谁能访问什么？IDOR, SSRF              |
| **A02** | 安全配置错误     | 默认设置、响应头、暴露的服务          |
| **A03** | 软件供应链 🆕    | 依赖项、CI/CD、构建完整性             |
| **A04** | 加密失败         | 弱加密算法、暴露的机密信息            |
| **A05** | 注入 (Injection) | 用户输入 → 系统命令                   |
| **A06** | 不安全的设计     | 架构层面的缺陷                        |
| **A07** | 认证失败         | 会话管理、凭据管理                    |
| **A08** | 完整性失败       | 未签名的更新、被篡改的数据            |
| **A09** | 记录与警报       | 盲区、缺乏监控                        |
| **A10** | 异常情况处理 🆕  | 错误处理、开启型失效 (Fail-open) 状态 |

### 2025 年关键变化

```
从 2021 到 2025 的演变：
├── SSRF 已合并至 A01 (访问控制)
├── A02 等级提升 (侧重于云端/容器配置)
├── A03 新增：供应链 (核心关注点)
├── A10 新增：异常情况处理
└── 重心转移：寻找根因 (Root causes) 而非症状
```

---

## 3. 供应链安全 (A03)

### 攻击面

| 向量                    | 风险                     | 关键提问                 |
| ----------------------- | ------------------------ | ------------------------ |
| **依赖项**              | 恶意软件包               | 我们是否审计了新增依赖？ |
| **锁文件 (Lock files)** | 完整性攻击               | 是否已提交至仓库？       |
| **构建流水线**          | CI/CD 被劫持             | 谁能修改配置？           |
| **注册表 (Registry)**   | 拼写劫持 (Typosquatting) | 是否为可信来源？         |

### 防御原则

- 验证软件包完整性（校验和 Checksums）
- 锁定版本，审计更新
- 针对核心依赖使用私有注册表
- 对产物进行签名与验证

---

## 4. 攻击面映射

### 映射对象

| 类别         | 元素                               |
| ------------ | ---------------------------------- |
| **入口点**   | API、表单、文件上传                |
| **数据流**   | 输入 → 处理 → 输出                 |
| **信任边界** | 检查认证/鉴权的位置                |
| **资产**     | 机密、PII (个人身份信息)、业务数据 |

### 优先级矩阵

```
风险 (Risk) = 可能性 (Likelihood) × 影响 (Impact)

高影响 + 高可能性 → 紧急 (CRITICAL)
高影响 + 低可能性 → 高 (HIGH)
低影响 + 高可能性 → 中 (MEDIUM)
低影响 + 低可能性 → 低 (LOW)
```

---

## 5. 风险优先级排序

### CVSS + 上下文

| 因素          | 权重         | 提问             |
| ------------- | ------------ | ---------------- |
| **CVSS 评分** | 基础严重程度 | 该漏洞有多严重？ |
| **EPSS 评分** | 利用可能性   | 是否正被利用？   |
| **资产价值**  | 业务背景     | 什么处于风险中？ |
| **暴露程度**  | 攻击面       | 是否面向互联网？ |

### 优先级决策树

```
是否正被积极利用 (EPSS > 0.5)？
├── 是 → 紧急 (CRITICAL)：立即采取行动
└── 否 → 检查 CVSS
         ├── CVSS ≥ 9.0 → 高 (HIGH)
         ├── CVSS 7.0 - 8.9 → 考虑资产价值
         └── CVSS < 7.0 → 稍后排期
```

---

## 6. 异常情况处理 (A10 - 新增)

### 开启型失效 (Fail-Open) vs 闭合型失效 (Fail-Closed)

| 场景     | 开启型 (错误做法) | 闭合型 (正确做法) |
| -------- | ----------------- | ----------------- |
| 认证错误 | 允许访问          | 拒绝访问          |
| 解析失败 | 接受输入          | 拒绝输入          |
| 超时     | 无限重试          | 限制次数并终止    |

### 检查重点

- 捕获所有异常并忽略的异常处理器
- 安全操作中缺失的错误处理
- 认证/鉴权中的竞争条件 (Race conditions)
- 资源枯竭场景

---

## 7. 扫描方法论

### 分阶段方法

```
1. 侦察 (RECONNAISSANCE)
   └── 了解目标
       ├── 技术栈
       ├── 入口点
       └── 数据流

2. 发现 (DISCOVERY)
   └── 识别潜在问题
       ├── 配置评审
       ├── 依赖分析
       └── 代码模式搜索

3. 分析 (ANALYSIS)
   └── 验证与优先级排序
       ├── 消除误报 (False positive)
       ├── 风险评分
       └── 攻击链映射

4. 报告 (REPORTING)
   └── 提供可执行的发现
       ├── 清晰的复现步骤
       ├── 业务影响
       ├── 修复建议
```

---

## 8. 代码模式分析

### 高风险模式

| 模式                   | 风险                 | 寻找特征                          |
| ---------------------- | -------------------- | --------------------------------- |
| **查询中的字符串拼接** | 注入 (Injection)     | `"SELECT * FROM " + 用户输入`     |
| **动态代码执行**       | 远程代码执行 (RCE)   | `eval()`, `exec()`, `Function()`  |
| **不安全的反序列化**   | RCE                  | `pickle.loads()`, `unserialize()` |
| **路径操纵**           | 路径遍历 (Traversal) | 文件路径中包含用户输入            |
| **禁用安全特性**       | 多种风险             | `verify=False`, `--insecure`      |

### 机密信息 (Secret) 模式

| 类型          | 迹象                            |
| ------------- | ------------------------------- |
| API 密钥      | `api_key`, `apikey`, 高熵字符串 |
| 令牌 (Tokens) | `token`, `bearer`, `jwt`        |
| 凭据          | `password`, `secret`, `key`     |
| 云端凭据      | `AWS_`, `AZURE_`, `GCP_` 前缀   |

---

## 9. 云安全考量

### 责任共担模型 (Shared Responsibility)

| 层级            | 你负责     | 服务商负责 |
| --------------- | ---------- | ---------- |
| 数据            | ✅         | ❌         |
| 应用层          | ✅         | ❌         |
| 操作系统/运行时 | 视情况而定 | 视情况而定 |
| 基础设施        | ❌         | ✅         |

### 云端特定检查

- IAM：是否应用了最小特权？
- 存储：是否存在公开的存储桶 (Buckets)？
- 网络：安全组是否已收紧？
- 机密：是否使用了机密管理器 (Secrets Manager)？

---

## 10. 反模式 (Anti-Patterns)

| ❌ 不要 (Don't)          | ✅ 要 (Do)                   |
| ------------------------ | ---------------------------- |
| 在不了解目标的情况下扫描 | 先映射攻击面                 |
| 对每个 CVE 都发出警报    | 根据可利用性与资产重要性排序 |
| 忽视误报                 | 维护经过验证的基准线         |
| 仅修复症状               | 解决根本原因                 |
| 部署前仅扫描一次         | 持续扫描                     |
| 盲目信任第三方依赖       | 验证完整性，审计代码         |

---

## 11. 报告原则

### 发现项结构

每个发现项应回答：

1. **是什么？** —— 清晰的漏洞描述
2. **在哪里？** —— 确切位置（文件、行号、端点）
3. **为什么？** —— 根本原因解释
4. **影响？** —— 业务后果
5. **如何修复？** —— 具体的修复方案

### 严重性分级

| 严重程度            | 标准                                  |
| ------------------- | ------------------------------------- |
| **紧急 (Critical)** | RCE、认证绕过、大规模数据泄露         |
| **高 (High)**       | 数据泄露、提权 (Privilege escalation) |
| **中 (Medium)**     | 范围有限，需要特定条件                |
| **低 (Low)**        | 信息类、最佳实践建议                  |

---

> **记住：** 漏洞扫描是为了发现问题，而专家的思考是为了决定哪些问题最重要。始终追问：“攻击者会利用这个漏洞做什么？”
