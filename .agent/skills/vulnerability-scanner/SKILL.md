---
name: vulnerability-scanner
description: 漏洞分析原则、OWASP Top 10 与供应链安全
allowed-tools: Read, Glob, Grep, Bash
---

# Vulnerability Scanner - 漏洞分析

> 像攻击者一样思考，像专家一样防御。2025 威胁态势感知。

## 🔧 运行时脚本

**执行以进行自动验证：**

| 脚本                       | 用途                   | 用法                                             |
| -------------------------- | ---------------------- | ------------------------------------------------ |
| `scripts/security_scan.py` | 验证是否应用了安全原则 | `python scripts/security_scan.py <project_path>` |

## 📋 参考文件

| 文件                           | 用途                                  |
| ------------------------------ | ------------------------------------- |
| [checklists.md](checklists.md) | OWASP Top 10, 认证, API, 数据保护清单 |

---

## 1. 安全专家心态

### 核心原则

| 原则                            | 应用                         |
| ------------------------------- | ---------------------------- |
| **假设被攻破 (Assume Breach)**  | 假设攻击者已经在内部进行设计 |
| **零信任 (Zero Trust)**         | 永不信任，始终验证           |
| **纵深防御 (Defense in Depth)** | 多层防御，无单点故障         |
| **最小权限 (Least Privilege)**  | 仅限所需的最小访问权限       |
| **失效安全 (Fail Secure)**      | 出现错误时，拒绝访问         |

### 威胁建模问题

在扫描之前，问：

1. 我们正在保护什么？(资产)
2. 谁会攻击？(威胁行为者)
3. 他们会如何攻击？(攻击向量)
4. 影响是什么？(业务风险)

---

## 2. OWASP Top 10:2025

### 风险类别

| 排名    | 类别               | 思考方向                    |
| ------- | ------------------ | --------------------------- |
| **A01** | 失效的访问控制     | 谁能访问什么？IDOR, SSRF    |
| **A02** | 安全配置错误       | 默认值，Headers，暴露的服务 |
| **A03** | 软件供应链安全 🆕  | 依赖，CI/CD，构建完整性     |
| **A04** | 加密失败           | 弱加密，暴露的密钥          |
| **A05** | 注入               | 用户输入 → 系统命令         |
| **A06** | 不安全的设计       | 缺陷架构                    |
| **A07** | 身份验证失败       | 会话，凭证管理              |
| **A08** | 完整性失败         | 未签名的更新，被篡改的数据  |
| **A09** | 安全日志和监控失败 | 盲点，无监控                |
| **A10** | 异常情况处理 🆕    | 错误处理，失效开放状态      |

---

## 3. 供应链安全

### 攻击面

| 向量           | 风险       | 要问的问题         |
| -------------- | ---------- | ------------------ |
| **依赖**       | 恶意包     | 我们审计新依赖吗？ |
| **锁文件**     | 完整性攻击 | 它们已提交吗？     |
| **构建流水线** | CI/CD 妥协 | 谁可以修改？       |
| **注册表**     | 域名抢注   | 验证的来源？       |

### 防御原则

- 验证包完整性 (checksums)
- 锁定版本，审计更新
- 对关键依赖使用私有注册表
- 签名并验证 Artifacts

---

## 4. 攻击面映射

### 映射什么

| 类别         | 元素                   |
| ------------ | ---------------------- |
| **入口点**   | API, 表单, 文件上传    |
| **数据流**   | 输入 → 处理 → 输出     |
| **信任边界** | 检查 auth/authz 的地方 |
| **资产**     | 密钥, PII, 业务数据    |

### 优先级矩阵

```
风险 = 可能性 × 影响

高影响 + 高可能性 → CRITICAL
高影响 + 低可能性 → HIGH
低影响 + 高可能性 → MEDIUM
低影响 + 低可能性 → LOW
```

---

## 5. 风险优先级

### CVSS + 上下文

| 因素          | 权重       | 问题               |
| ------------- | ---------- | ------------------ |
| **CVSS 分数** | 基础严重性 | 漏洞有多严重？     |
| **EPSS 分数** | 利用可能性 | 它正在被利用吗？   |
| **资产价值**  | 业务上下文 | 这里的风险是什么？ |
| **暴露**      | 攻击面     | 面向互联网吗？     |

---

## 6. 异常情况

### 失效开放 (Fail-Open) vs 失效关闭

| 场景     | 失效开放 (坏) | 失效关闭 (好) |
| -------- | ------------- | ------------- |
| 认证错误 | 允许访问      | 拒绝访问      |
| 解析失败 | 接受输入      | 拒绝输入      |
| 超时     | 永远重试      | 限制 + 中止   |

### 检查什么

- 捕获所有并忽略的异常处理程序
- 安全操作上缺少错误处理
- auth/authz 中的竞争条件
- 资源耗尽场景

---

## 7. 扫描方法论

### 基于阶段的方法

```
1. 侦察 (RECONNAISSANCE)
   └── 理解目标
       ├── 技术栈
       ├── 入口点
       └── 数据流

2. 发现 (DISCOVERY)
   └── 识别潜在问题
       ├── 配置审查
       ├── 依赖分析
       └── 代码模式搜索

3. 分析 (ANALYSIS)
   └── 验证和优先排序
       ├── 消除误报
       ├── 风险评分
       └── 攻击链映射

4. 报告 (REPORTING)
   └── 可操作的发现
       ├── 清晰的重现步骤
       ├── 业务影响
       └── 补救指导
```

---

## 8. 代码模式分析

### 高风险模式

| 模式                   | 风险 | 寻找                              |
| ---------------------- | ---- | --------------------------------- |
| **查询中的字符串拼接** | 注入 | `"SELECT * FROM " + user_input`   |
| **动态代码执行**       | RCE  | `eval()`, `exec()`, `Function()`  |
| **不安全的反序列化**   | RCE  | `pickle.loads()`, `unserialize()` |
| **路径操作**           | 遍历 | 文件路径中的用户输入              |
| **禁用的安全性**       | 各种 | `verify=False`, `--insecure`      |

### 密钥模式

| 类型        | 指示器                        |
| ----------- | ----------------------------- |
| API Keys    | `api_key`, `apikey`, 高熵     |
| Tokens      | `token`, `bearer`, `jwt`      |
| Credentials | `password`, `secret`, `key`   |
| Cloud       | `AWS_`, `AZURE_`, `GCP_` 前缀 |

---

## 9. 云安全考量

### 责任共担

| 层        | 你拥有 | 提供商拥有 |
| --------- | ------ | ---------- |
| 数据      | ✅     | ❌         |
| 应用      | ✅     | ❌         |
| OS/运行时 | 取决于 | 取决于     |
| 基础设施  | ❌     | ✅         |

### 云特定检查

- IAM: 应用了最小权限吗？
- 存储: 公共存储桶？
- 网络: 安全组收紧了吗？
- 密钥: 使用密钥管理器吗？

---

## 10. 反模式

| ❌ 不要 (Don't)    | ✅ 要 (Do)                |
| ------------------ | ------------------------- |
| 不理解就扫描       | 首先映射攻击面            |
| 对每个 CVE 告警    | 按可利用性 + 资产优先排序 |
| 忽略误报           | 维护已验证的基线          |
| 仅修复症状         | 解决根本原因              |
| 部署前扫描一次     | 持续扫描                  |
| 盲目信任第三方依赖 | 验证完整性，审计代码      |

---

## 11. 报告原则

### 发现结构

每个发现应回答：

1. **什么? (What?)** - 清晰的漏洞描述
2. **哪里? (Where?)** - 确切位置 (文件, 行, 端点)
3. **为什么? (Why?)** - 根本原因解释
4. **影响? (Impact?)** - 业务后果
5. **如何修复? (How to fix?)** - 具体补救措施

### 严重性分类

| 严重性       | 标准                             |
| ------------ | -------------------------------- |
| **Critical** | RCE, auth bypass, 大规模数据泄露 |
| **High**     | 数据泄露, 提权                   |
| **Medium**   | 范围有限, 需要条件               |
| **Low**      | 信息性的, 最佳实践               |

---

> **记住：** 漏洞扫描发现问题。专家思维优先考虑重要事项。始终问："攻击者会用这个做什么？"
