---
description: 移动端测试策略、单元测试、E2E 测试与设备场
---

# 移动端测试参考 (Mobile Testing Reference)

> 移动端测试策略、单元测试、E2E 测试与设备场。
> **移动端发布成本高 (审核慢)，Bug 修复难 (用户不更新)。测试是生命线。**

---

## 1. 移动端测试矩阵

| 工具                                    | 适用于             | 速度     | 可靠性   | 备注                 |
| :-------------------------------------- | :----------------- | :------- | :------- | :------------------- |
| **Jest**                                | 单元逻辑, Reducers | ⚡⚡⚡⚡ | ⚡⚡⚡⚡ | 必须有，基础         |
| **RNTL** (React Native Testing Library) | 组件交互           | ⚡⚡⚡   | ⚡⚡⚡   | 测试组件行为         |
| **flutter_test**                        | Flutter            | ⚡⚡⚡   | ⚡⚡⚡   | Widget 测试          |
| **Detox**                               | RN                 | ⚡⚡     | ⚡⚡⚡   | E2E, 关键流程        |
| **Maestro**                             | Both               | ⚡⚡     | ⚡⚡     | E2E, 跨平台，易用    |
| **Appium**                              | Both               | ⚡       | ⚡       | 遗留技术，最后的手段 |

---

## 2. 移动端测试金字塔

```
                    ┌───────────────┐
                    │     E2E 测试   │  10%
                    │   (真机/模拟器) │  慢，昂贵，但至关重要
                    ├───────────────┤
                    │    集成测试    │  20%
                    │      (组件+)   │  组件 + 上下文
                    ├───────────────┤
                    │    组件测试    │  30%
                    │   (隔离 UI)   │  RNTL / Widget Tests
                    ├───────────────┤
                    │    单元测试    │  40%
                    │     (Jest)    │  纯逻辑，最快
                    └───────────────┘
```

### 为什么是这个比例？

| 层级         | 为什么                                                                     |
| :----------- | :------------------------------------------------------------------------- |
| **E2E 10%**  | 虽然慢且有时不稳定 (Flaky)，但能捕获集成和原生层面的 Bug。与后端真实交互。 |
| **集成 20%** | 测试用户流程，无需启动完整 App。                                           |
| **组件 30%** | 快速反馈 UI 交互，状态变化。                                               |
| **单元 40%** | 最快，最稳定，覆盖核心业务逻辑。                                           |

> 🔴 **如果你有 90% 的单元测试和 0% 的 E2E 测试，你在测试错误的东西。移动端的大部分 Bug 出在集成点。**

---

## 3. 各层级测什么

### 单元测试 (Jest)

```
✅ 测试:
├── 工具函数 (formatDate, calculatePrice)
├── 状态 Reducers (Redux/Zustand logic)
├── API 响应转换器
├── 验证逻辑
└── 业务规则

❌ 不测试:
├── 组件渲染 (用组件测试)
├── 导航 (用集成测试)
├── 原生模块 (Mock 掉它们)
└── 第三方库的内部实现
```

### 组件测试 (RNTL / flutter_test)

```
✅ 测试:
├── 组件能正确渲染
├── 用户交互 (点击, 输入, 滑动)
├── 加载/错误/空状态
├── 可访问性标签存在 (Accessibility Labels)
└── Props 变化时的行为

❌ 不测试:
├── 内部实现细节
├── 滥用快照 (Snapshot) (只对关键且稳定的组件用)
├── 样式细节 (脆弱)
└── 第三方组件内部
```

### 集成测试

```
✅ 测试:
├── 表单提交流程
├── 屏幕间导航
├── 跨屏幕的状态持久化
├── API 集成 (使用 Mock Server)
└── Context/Provider 交互

❌ 不测试:
├── 每种可能的逻辑路径 (用单元测试)
├── 真实的第三方服务 (Mock 掉)
└── 后端逻辑 (那是后端的责任)
```

### E2E 测试 (Detox / Maestro)

```
✅ 测试:
├── 关键用户旅程 (登录, 购买, 注册)
├── 离线 → 在线 转换
├── 深度链接 (Deep Link) 处理
├── 推送通知点击跳转
├── 权限申请流程
└── 支付流程 (沙盒)

❌ 不测试:
├── 每一个边缘情况 (太慢)
├── 视觉回归 (使用截图对比工具)
├── 非核心功能
└── 仅后端的逻辑
```

---

## 4. 平台特定测试

### iOS 与 Android 有何不同？

| 领域           | iOS 行为           | Android 行为       | 需要双端测试?    |
| :------------- | :----------------- | :----------------- | :--------------- |
| **返回导航**   | 边缘滑动           | 系统返回键         | ✅ 是            |
| **权限**       | 询问一次，去设置   | 每次询问，需要理由 | ✅ 是            |
| **键盘**       | 外观不同，处理不同 | 行为不同           | ✅ 是            |
| **日期选择器** | 滚轮/模态          | Material 对话框    | ⚠️ 如果自定义 UI |
| **推送格式**   | APNs payload       | FCM payload        | ✅ 是            |
| **深度链接**   | Universal Links    | App Links          | ✅ 是            |
| **手势**       | 某些独特手势       | Material 手势      | ⚠️ 如果自定义    |

### 平台测试策略

```
对于每个平台:
├── 运行单元测试 (双端逻辑通常相同)
├── 运行组件测试 (双端通常相同)
├── 运行 E2E 测试 (必须在双端运行)
│   ├── iOS: 真机或模拟器
│   └── Android: 中端真机 (不要只测旗舰机)
└── 分别测试平台特性 (权限、推送、支付)
```

---

## 5. 离线与网络测试

### 需要测试的离线场景

| 场景                   | 验证内容                     |
| :--------------------- | :--------------------------- |
| **离线启动 App**       | 显示缓存数据或友好的离线提示 |
| **操作中途断网**       | 操作进入队列，数据不丢失     |
| **恢复在线**           | 队列同步，无重复提交         |
| **慢速网络 (2G)**      | 加载状态正常，超时处理正常   |
| **不稳定网络 (Flaky)** | 重试逻辑，错误恢复           |

### 如何模拟网络条件

```
方法:
├── 单元测试: Mock NetInfo 状态，测试逻辑
├── 集成测试: Mock API 响应 (延迟/失败)，测试 UI
├── E2E (Detox): 使用 device.setURLBlacklist()
├── E2E (Maestro): 使用网络控制命令
└── 手动: 使用 Charles Proxy / Network Link Conditioner (iOS 设置)
```

---

## 6. 性能测试

### 测量什么

| 指标         | 目标         | 如何测量                       |
| :----------- | :----------- | :----------------------------- |
| **App 启动** | < 2 秒       | Profiler, Flashlight           |
| **屏幕切换** | < 300ms      | React DevTools                 |
| **列表滚动** | 60 FPS       | Profiler, 直观感受             |
| **内存**     | 稳定，无泄漏 | Instruments / Android Profiler |
| **包体积**   | 最小化       | Metro bundler analysis         |

### 何时进行性能测试

```
性能测试时机:
├── 发布前 (必须)
├── 添加重型功能后
├── 升级依赖后
├── 用户反馈卡顿时
└── 在 CI 上 (可选，自动化基准测试)

在哪测:
├── 真机 (必须)
├── 低端设备 (Galaxy A 系列, 旧 iPhone)
├── ❌ 绝对不要只在模拟器上测 (它在性能上撒谎)
└── 使用类生产数据 (不是 3 条数据，是 300 条)
```

---

## 7. 可访问性测试 (Accessibility)

### 验证什么

| 元素           | 检查                            |
| :------------- | :------------------------------ |
| **交互元素**   | 有 `accessibilityLabel`         |
| **图片**       | 有 `alt` 文本或标记为装饰性     |
| **表单**       | 标签与输入框关联                |
| **按钮**       | Role = button                   |
| **触摸目标**   | ≥ 44x44 (iOS) / 48x48 (Android) |
| **颜色对比度** | WCAG AA 标准                    |

### 如何测试

```
自动化:
├── React Native: jest-axe
├── Flutter: Tests 中的 Accessibility checker
└── Lint 规则 (eslint-plugin-react-native-a11y)

手动 (必须):
├── 开启 VoiceOver (iOS) / TalkBack (Android)
├── 闭眼 (或遮住屏幕) 导航整个 App
├── 测试大号字体 (系统设置)
└── 测试“减少动态”设置
```

---

## 8. CI/CD 集成

### 哪里跑什么

| 阶段                  | 测试类型    | 设备                      |
| :-------------------- | :---------- | :------------------------ |
| **PR (Pull Request)** | 单元 + 组件 | 无 (运行在 Node/JVM) - 快 |
| **Merge to main**     | + 集成测试  | 模拟器/仿真器             |
| **Pre-release**       | + E2E 测试  | 真机 (Device Farm)        |
| **Nightly (每晚)**    | 全套件      | Device Farm               |

### 设备场 (Device Farm) 选项

| 服务                  | 优点                    | 缺点               |
| :-------------------- | :---------------------- | :----------------- |
| **Firebase Test Lab** | 免费层级, Google 亲儿子 | Android 优先       |
| **AWS Device Farm**   | 以此类推，选择多        | 贵                 |
| **BrowserStack**      | 体验好                  | 贵                 |
| **本地真机**          | 免费, 可靠              | 维护麻烦，种类有限 |

---

## 📝 移动端测试检查清单

### 提 PR 前

- [ ] 新逻辑有单元测试
- [ ] 新 UI 有组件测试
- [ ] 测试中无 `console.log`
- [ ] CI 上的测试通过

### 发布前

- [ ] 在真实 iOS 设备上跑通 E2E
- [ ] 在真实 Android 设备上跑通 E2E
- [ ] 在低端设备上测试过性能
- [ ] 验证过离线场景
- [ ] 性能达标 (启动, 滚动)
- [ ] 可访问性验证过 (VoiceOver/TalkBack)

### 有意识地跳过 (What to Skip)

- [ ] 100% 覆盖率 (追求有意义的覆盖，而非数字)
- [ ] 每一个视觉排列组合 (节省快照测试)
- [ ] 第三方库的内部
- [ ] 纯后端逻辑 (那是后端的测试)

---

## 🎯 测试前要问的问题

在写测试之前，回答：

1.  **什么坏了最要命？** → 写 E2E 测试测它。
2.  **什么对用户最关键？** → 写 E2E 测试测它。
3.  **什么是复杂的逻辑？** → 写单元测试测它。
4.  **什么是平台特定的？** → 双端都要测。
5.  **离线时会发生什么？** → 测试该场景。

> **记住:** 好的移动端测试是关于测试**正确**的东西，而不是**所有**东西。一个不稳定的 E2E 测试比没有测试更糟糕。一个能捕获 Bug 的失败单元测试比 100 个通过的琐碎测试更有价值。
