---
name: testing-patterns
description: 测试模式、Mocking 策略与测试金字塔
allowed-tools: Read, Write, Edit, Glob, Grep, Bash
---

# 测试模式 (Testing Patterns)

> 编写可靠测试套件的原则。

---

## 1. 测试金字塔 (Testing Pyramid)

```
        /\          E2E 测试 (极少)
       /  \         关键业务流程
      /----\
     /      \       集成测试 (Integration) (少量)
    /--------\      API、数据库查询
   /          \
  /------------\    单元测试 (Unit) (大量)
                    函数、类
```

---

## 2. AAA 模式

| 步骤               | 目的         |
| ------------------ | ------------ |
| **编排 (Arrange)** | 准备测试数据 |
| **执行 (Act)**     | 运行待测代码 |
| **断言 (Assert)**  | 验证结果     |

---

## 3. 测试类型选择

### 何时使用

| 类型                       | 最适合场景          | 速度         |
| -------------------------- | ------------------- | ------------ |
| **单元测试 (Unit)**        | 纯函数、逻辑代码    | 极快 (<50ms) |
| **集成测试 (Integration)** | API、数据库、服务层 | 中等         |
| **端到端测试 (E2E)**       | 关键用户流程        | 慢           |

---

## 4. 单元测试原则

### 优秀的单元测试

| 原则                 | 含义             |
| -------------------- | ---------------- |
| 快速 (Fast)          | 每个测试 < 100ms |
| 隔离 (Isolated)      | 不依赖外部环境   |
| 可重复 (Repeatable)  | 结果始终如一     |
| 自查 (Self-checking) | 无需人工核对     |
| 及时 (Timely)        | 与代码同步编写   |

### 单元测试范围

| 要测试   | 不要测试           |
| -------- | ------------------ |
| 业务逻辑 | 框架代码           |
| 边缘情况 | 第三方库           |
| 错误处理 | 简单的 Getter 方法 |

---

## 5. 集成测试原则

### 测试内容

| 领域     | 关注点                |
| -------- | --------------------- |
| API 端点 | 请求/响应             |
| 数据库   | 查询、事务            |
| 外部服务 | 契约 (Contracts) 验证 |

### 设置与清理 (Setup/Teardown)

| 阶段                     | 采取行动 |
| ------------------------ | -------- |
| Before All (全部开始前)  | 连接资源 |
| Before Each (每个开始前) | 重置状态 |
| After Each (每个结束后)  | 清理数据 |
| After All (全部结束后)   | 断开连接 |

---

## 6. 模拟 (Mocking) 原则

### 何时使用 Mock

| 要 Mock              | 不要 Mock          |
| -------------------- | ------------------ |
| 外部 API             | 正在测试的代码本身 |
| 数据库（单元测试中） | 简单的依赖项       |
| 时间/随机数          | 纯函数             |
| 网络请求             | 内存存储器         |

### Mock 类型

| 类型        | 用途         |
| ----------- | ------------ |
| 桩 (Stub)   | 返回固定值   |
| 间谍 (Spy)  | 追踪调用情况 |
| 模拟 (Mock) | 设置预期行为 |
| 伪造 (Fake) | 简化版的实现 |

---

## 7. 测试组织

### 命名规范

| 模式            | 示例                                             |
| --------------- | ------------------------------------------------ |
| Should (应表现) | “当……时应返回错误 (should return error when...)” |
| When (当……)     | “当用户未找到时…… (when user not found...)”      |
| Given-when-then | “在 X 情况下，当执行 Y，则得到 Z”                |

### 分组方式

| 层级       | 用途             |
| ---------- | ---------------- |
| describe   | 将相关测试归组   |
| it/test    | 单个测试用例     |
| beforeEach | 公用的初始化设置 |

---

## 8. 测试数据

### 策略

| 方案              | 用途               |
| ----------------- | ------------------ |
| 工厂 (Factories)  | 动态生成测试数据   |
| 固件 (Fixtures)   | 预定义的静态数据集 |
| 构建器 (Builders) | 链式创建复杂对象   |

### 原则

- 使用真实的数据
- 随机化非关键数值（使用 Faker 库）
- 共享通用的固件
- 保持数据精简

---

## 9. 最佳实践

| 实践项目         | 原因             |
| ---------------- | ---------------- |
| 每个测试一个断言 | 失败原因清晰     |
| 测试相互独立     | 无需考虑运行顺序 |
| 快速测试         | 能够频繁运行     |
| 描述性名称       | 代码即文档       |
| 必须清理         | 避免副作用       |

---

## 10. 反模式 (Anti-Patterns)

| ❌ 不要 (Don't)  | ✅ 要 (Do)   |
| ---------------- | ------------ |
| 测试实现细节     | 测试行为表现 |
| 重复编写测试代码 | 使用工厂模式 |
| 复杂的测试设置   | 简化或拆分   |
| 忽视不稳定的测试 | 修复根本原因 |
| 跳过清理步骤     | 重置环境状态 |

---

> **记住：** 测试即文档。如果别人无法通过测试理解代码的功能，请重写它们。
