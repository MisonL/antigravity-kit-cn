---
name: deployment-procedures
description: 生产环境部署原则与决策。包含安全部署工作流、回滚策略及验证。教导思考而非死记硬背脚本。
allowed-tools: Read, Glob, Grep, Bash
---

# 部署规程

> 旨在确保生产环境发布安全性的部署原则与决策逻辑。
> **学习如何思考（THINK），而非死记硬背脚本模式。**

---

## ⚠️ 如何使用此技能

此技能传授的是**部署原则**，而不是可以盲目复制的 Bash 脚本。

- 每次部署都是大相径庭的。
- 理解每一步背后的“为什么（WHY）”。
- 根据您的具体平台灵活调整规程。

---

## 1. 平台选择

### 决策树

```
您正在部署什么？
│
├── 静态站点 / JAMstack（静态应用架构）
│   └── Vercel, Netlify, Cloudflare Pages
│
├── 简单 Web 应用
│   ├── 托管服务（managed） → Railway, Render, Fly.io
│   └── 自主控制（control） → VPS + PM2/Docker
│
├── 微服务（microservices）
│   └── 容器编排（container orchestration）
│
└── 无服务器（serverless）
    └── 边缘函数（edge functions）, Lambda
```

### 不同平台具有不同的规程

| 平台 | 部署方式 |
| ---- | -------- |
| **Vercel/Netlify** | Git push（推送代码），自动部署 |
| **Railway/Render** | Git push 或 CLI 命令行 |
| **VPS + PM2** | SSH + 手动步骤 |
| **Docker** | 镜像推送 + 编排 |
| **Kubernetes** | kubectl apply |

---

## 2. 部署前原则

### 四大验证类别

| 类别 | 检查项 |
| ---- | ------ |
| **代码质量** | 测试通过、Lint（规范检查）清理完成、已通过评审 |
| **构建（build）** | 生产环境构建成功，无告警 |
| **环境** | 环境变量已设置，凭据（secrets）已更新 |
| **安全性** | 已完成备份，回滚计划已就绪 |

### 部署前检查清单

- [ ] 所有测试均已通过。
- [ ] 代码已通过评审并获得批准。
- [ ] 生产环境构建成功。
- [ ] 环境变量已验证。
- [ ] 数据库迁移已就绪（如有）。
- [ ] 回滚计划已记录。
- [ ] 已通知团队。
- [ ] 监控系统已就绪。

---

## 3. 部署工作流原则

### 5 阶段流程

```
1. 准备（PREPARE）
   └── 验证代码、构建、环境变量

2. 备份（BACKUP）
   └── 在变更前保存当前状态

3. 部署（DEPLOY）
   └── 在开启监控的情况下执行

4. 验证（VERIFY）
   └── 健康检查、日志、核心流程

5. 确认或回滚（CONFIRM or ROLLBACK）
   └── 一切正常？确认。有问题？回滚。
```

### 阶段原则

| 阶段 | 原则 |
| ---- | ---- |
| **准备** | 绝不部署未经测试的代码 |
| **备份** | 没有备份就无法实现回滚 |
| **部署** | 观察其发生过程，不要中途走开 |
| **验证** | 宁可怀疑，务必验证 |
| **确认** | 随时准备好触发回滚操作 |

---

## 4. 部署后验证

### 验证内容

| 检查项 | 为什么要查 |
| ------ | ---------- |
| **健康端点（health）** | 确保服务正在运行 |
| **错误日志** | 确认没有出现新的报错 |
| **核心业务流** | 确保关键功能正常运行 |
| **性能** | 响应时间在可接受范围内 |

### 验证时间窗口

- **首个 5 分钟**：主动实时监控。
- **15 分钟**：确认运行稳定。
- **1 小时**：进行最终验证。
- **次日**：复审各项指标。

---

## 5. 回滚原则

### 何时回滚

| 现象 | 行动建议 |
| ---- | -------- |
| 服务宕机（down） | 立即回滚 |
| 出现严重错误 | 回滚 |
| 性能下降超过 50% | 考虑回滚 |
| 细微问题 | 如果能快速修复，则进行“向前修复（fix forward）” |

### 不同平台的回滚策略

| 平台 | 回滚方式 |
| ---- | -------- |
| **Vercel/Netlify** | 重新部署之前的提交记录（commit） |
| **Railway/Render** | 在控制面板中执行回滚 |
| **VPS + PM2** | 还原备份并重启 |
| **Docker** | 使用之前的镜像标签（tag） |
| **K8s** | 执行 kubectl rollout undo |

### 回滚原则

1. **速度优于完美**：先回滚，再调试。
2. **不要复合错误**：只进行一次回滚，不要同时做多项变更。
3. **沟通**：告知团队发生了什么。
4. **复盘（Post-mortem）**：在系统稳定后理解原因。

---

## 6. 零停机部署

### 核心策略

| 策略 | 工作原理 |
| ---- | -------- |
| **滚动更新（rolling）** | 逐个替换实例 |
| **蓝绿部署（blue-green）** | 在不同环境间切换流量 |
| **金丝雀发布（canary）** | 逐渐转移流量 |

### 选择原则

| 场景 | 对应策略 |
| ---- | -------- |
| 标准发布 | 滚动更新 |
| 高风险变更 | 蓝绿部署（易于回滚） |
| 需要验证 | 金丝雀发布（使用真实流量测试） |

---

## 7. 应急响应程序

### 服务宕机优先级

1. **评估（assess）**：现象是什么？
2. **快速修复**：如果不明确原因，先试着重启。
3. **回滚**：如果重启无效，立即回滚。
4. **调查**：在系统稳定后进行深入分析。

### 调查顺序

| 检查项 | 常见问题 |
| ------ | -------- |
| **日志** | 错误、异常信息 |
| **系统资源** | 磁盘空间满、内存不足 |
| **网络** | DNS 问题、防火墙拦截 |
| **依赖项** | 数据库异常、API 故障 |

---

## 8. 反模式（应避免的行为，Anti-Patterns）

| ❌ 禁止（Don't） | ✅ 推荐（Do） |
| -------------- | ------------ |
| 在周五进行部署 | 在周初进行部署 |
| 仓促部署 | 遵循既定流程 |
| 跳过预发布环境（Staging） | 始终先测试 |
| 部署前不备份 | 部署前必备份 |
| 部署完立即走开 | 监控至少 15 分钟以上 |
| 同时进行多项变更 | 每次只进行一项变更 |

---

## 9. 决策检查清单（Decision Checklist）

在部署之前：

- [ ] **是否选择了适用于该平台的规程？**
- [ ] **备份策略是否已就绪？**
- [ ] **回滚计划是否已记录？**
- [ ] **监控是否已配置？**
- [ ] **是否已通知团队？**
- [ ] **事后是否有足够的监控时间？**

---

## 10. 最佳实践（Best Practices）

1. **小步快跑**：采用高频率的小规模部署，而非大规模集中发布。
2. **功能开关（Feature flags）**：针对高风险变更使用开关控制。
3. **自动化**：将重复性步骤自动化。
4. **记录**：记录每一次部署的过程。
5. **复审**：在出问题后复盘原因。
6. **测试回滚**：在真正需要之前先演练回滚。

---
