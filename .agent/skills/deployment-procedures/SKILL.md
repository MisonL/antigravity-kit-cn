---
name: deployment-procedures
description: 生产环境部署原则与决策。包含安全部署工作流、回滚策略和验证机制。旨在传授思考方式而非死记硬背脚本。
allowed-tools: Read, Glob, Grep, Bash
---

# 部署规程 (Deployment Procedures)

> 生产环境安全发布的部署原则与决策。
> **学会思考，而不是死记硬背脚本。**

---

## ⚠️ 如何使用此技能

本技能教授的是 **部署原则**，而不是可以无脑复制的 Bash 脚本。

- 每次部署都是独特的。
- 理解每一步背后的 **为什么 (WHY)**。
- 根据您的平台灵活调整流程。

---

## 1. 平台选择 (Platform Selection)

### 决策树

```
您要部署什么？
│
├── 静态网站 / JAMstack
│   └── Vercel, Netlify, Cloudflare Pages
│
├── 简单的 Web 应用
│   ├── 托管服务 (Managed) → Railway, Render, Fly.io
│   └── 完全控制 (Control) → VPS + PM2/Docker
│
├── 微服务
│   └── 容器编排 (Container orchestration)
│
└── 无服务器 (Serverless)
    └── Edge functions, Lambda
```

### 不同平台有不同的操作流程

| 平台               | 部署方式             |
| ------------------ | -------------------- |
| **Vercel/Netlify** | Git push, 自动部署   |
| **Railway/Render** | Git push 或 CLI 部署 |
| **VPS + PM2**      | SSH + 手动步骤       |
| **Docker**         | 镜像推送 + 编排工具  |
| **Kubernetes**     | kubectl apply        |

---

## 2. 预部署原则 (Pre-Deployment Principles)

### 4 大验证类别

| 类别         | 检查项                                      |
| ------------ | ------------------------------------------- |
| **代码质量** | 测试通过, Lint 检查无误, 已通过 Code Review |
| **构建**     | 生产环境构建成功, 无警告                    |
| **环境**     | 环境变量已设置, 密钥信息是最新的            |
| **安全性**   | 备份已完成, 回滚计划已就绪                  |

### 预部署检查清单 (Post-Deployment Checklist)

- [ ] 所有测试均已通过
- [ ] 代码已通过 Review 并获得批准
- [ ] 生产环境构建成功
- [ ] 环境变量已验证
- [ ] 数据库迁移已就绪 (如有)
- [ ] 回滚计划已记录
- [ ] 已通知相关团队
- [ ] 监控系统已就绪

---

## 3. 部署工作流原则 (Deployment Workflow Principles)

### 5 阶段流程

```
1. 准备 (PREPARE)
   └── 验证代码、构建产物、环境变量

2. 备份 (BACKUP)
   └── 在发生变更前保存当前状态

3. 部署 (DEPLOY)
   └── 在开启监控的情况下执行部署

4. 验证 (VERIFY)
   └── 健康检查、日志审计、核心流程测试

5. 确认或回滚 (CONFIRM or ROLLBACK)
   └── 一切正常？确认。有问题？回滚。
```

### 阶段性原则

| 阶段     | 原则                              |
| -------- | --------------------------------- |
| **准备** | 严禁部署未经测试的代码            |
| **备份** | 没有备份就无法真正实现回滚        |
| **部署** | 盯着部署过程，不要中途走开        |
| **验证** | 信任但必须验证 (Trust but verify) |
| **确认** | 随时准备好触发回滚操作            |

---

## 4. 部署后验证 (Post-Deployment Verification)

### 需要验证的内容

| 检查项           | 原因                       |
| ---------------- | -------------------------- |
| **健康检查端点** | 确保服务正在运行           |
| **错误日志**     | 确认没有出现新的异常       |
| **核心用户流程** | 验证关键功能是否正常工作   |
| **性能指标**     | 确保响应时间在可接受范围内 |

### 验证窗口期

- **前 5 分钟**: 主动监控
- **15 分钟**: 确认运行稳定
- **1 小时**: 进行最终验证
- **次日**: 复审各项指标

---

## 5. 回滚原则 (Rollback Principles)

### 何时进行回滚

| 现象            | 行动建议                                     |
| --------------- | -------------------------------------------- |
| 服务宕机 (Down) | 立即回滚                                     |
| 出现严重错误    | 回滚                                         |
| 性能下降 >50%   | 考虑回滚                                     |
| 次要问题        | 如果能快速修复，则选择前向修复 (Fix forward) |

### 各平台的回滚策略

| 平台               | 回滚方式                    |
| ------------------ | --------------------------- |
| **Vercel/Netlify** | 重新部署之前的 Commit       |
| **Railway/Render** | 在控制台点击回滚按钮        |
| **VPS + PM2**      | 恢复备份并重启服务          |
| **Docker**         | 使用之前的镜像 Tag 重新部署 |
| **Kubernetes**     | 使用 `kubectl rollout undo` |

### 回滚核心准则

1. **速度优于完美**: 先回滚，后调试。
2. **不要复合错误**: 只做一次回滚，不要同时尝试多个变更。
3. **及时沟通**: 告知团队发生了什么。
4. **复盘 (Post-mortem)**: 系统稳定后，深入理解失败原因。

---

## 6. 零停机部署 (Zero-Downtime Deployment)

### 常见策略

| 策略                      | 工作原理                   |
| ------------------------- | -------------------------- |
| **滚动更新 (Rolling)**    | 逐个替换服务实例           |
| **蓝绿部署 (Blue-Green)** | 在两个环境之间整体切换流量 |
| **金丝雀发布 (Canary)**   | 逐步迁移一部分流量进行压测 |

### 策略选择原则

| 场景             | 推荐策略            |
| ---------------- | ------------------- |
| 标准版本发布     | 滚动更新            |
| 高风险变更       | 蓝绿部署 (回滚极快) |
| 需要真实流量验证 | 金丝雀发布          |

---

## 7. 应急预案 (Emergency Procedures)

### 服务的宕机处理优先级

1. **评估 (Assess)**: 报错现象是什么？
2. **快速修复**: 如果原因不明，先尝试重启。
3. **回滚**: 如果重启无效，执行回滚。
4. **调查**: 系统恢复稳定后，再进行深入调查。

### 调查顺序

| 检查项               | 常见问题                     |
| -------------------- | ---------------------------- |
| **日志 (Logs)**      | 报错信息、异常堆栈           |
| **资源 (Resources)** | 磁盘空间不足、内存溢出 (OOM) |
| **网络 (Network)**   | DNS 故障、防火墙策略         |
| **依赖项**           | 数据库挂起、API 超时         |

---

## 8. 反模式 (应避免的做法)

| ❌ 错误做法 (Don't)       | ✅ 正确做法 (Do)         |
| ------------------------- | ------------------------ |
| 在周五进行部署            | 在周初进行部署           |
| 仓促部署                  | 严格遵循既定流程         |
| 跳过预发布 (Staging) 环境 | 始终先在环境预览中测试   |
| 没做备份就部署            | 部署前必做备份           |
| 部署完直接走开            | 持续监控至少 15 分钟以上 |
| 一次性进行多个变更        | 每次只做一个逻辑变更     |

---

## 9. 决策检查清单 (Decision Checklist)

部署前请最终确认：

- [ ] **流程是否适配当前平台？**
- [ ] **备份策略已就绪？**
- [ ] **回滚计划已清楚记录？**
- [ ] **监控看板已配置妥当？**
- [ ] **是否已通知相关团队？**
- [ ] **部署后是否有充足时间进行监控？**

---

## 10. 最佳实践 (Best Practices)

1. **小而频繁的部署** 优于大版本更新。
2. 对于风险较高的变更，使用 **特性开关 (Feature flags)**。
3. 将重复性的步骤 **自动化**。
4. **文档化** 记录每一次重要的部署。
5. 在出现问题后，务必进行 **复盘 (Review)**。
6. 在真正需要之前，先 **测试回滚** 流程。

---

> **记住：** 每次部署都伴随着风险。请通过充分的准备来最小化风险，而不是追求速度。
