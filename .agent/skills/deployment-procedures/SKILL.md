---
name: deployment-procedures
description: 生产部署原则与决策。安全部署工作流、回滚策略和验证。教导思考而非脚本。
allowed-tools: Read, Glob, Grep, Bash
---

# Deployment Procedures - 部署流程

> 安全生产发布的部署原则与决策。
> **学会思考，而不是死记脚本。**

---

## ⚠️ 如何使用此 Skill

本 Skill 教授 **部署原则**，而非供复制的 Bash 脚本。

- 每次部署都是独特的
- 理解每一步背后的“为什么”
- 调整流程以适应你的平台

---

## 1. 平台选择 (Platform Selection)

### 决策树

```
你要部署什么？
│
├── 静态网站 / JAMstack
│   └── Vercel, Netlify, Cloudflare Pages
│
├── 简单 Web 应用
│   ├── 托管服务 → Railway, Render, Fly.io
│   └── 自控 → VPS + PM2/Docker
│
├── 微服务
│   └── 容器编排
│
└── Serverless
    └── Edge functions, Lambda
```

### 每个平台有不同的流程

| 平台               | 部署方法           |
| ------------------ | ------------------ |
| **Vercel/Netlify** | Git push, 自动部署 |
| **Railway/Render** | Git push 或 CLI    |
| **VPS + PM2**      | SSH + 手动步骤     |
| **Docker**         | 镜像推送 + 编排    |
| **Kubernetes**     | kubectl apply      |

---

## 2. 部署前原则 (Pre-Deployment Principles)

### 4 类验证

| 类别         | 检查什么                      |
| ------------ | ----------------------------- |
| **代码质量** | 测试通过，Lint 无警告，已审查 |
| **构建**     | 生产构建成功，无警告          |
| **环境**     | 环境变量已设置，密钥最新      |
| **安全**     | 备份已完成，回滚计划已就绪    |

### 部署前检查清单

- [ ] 所有测试通过
- [ ] 代码已审查并批准
- [ ] 生产构建成功
- [ ] 环境变量已验证
- [ ] 数据库迁移已就绪 (如果有)
- [ ] 回滚计划已文档化
- [ ] 已通知团队
- [ ] 监控已就绪

---

## 3. 部署工作流原则 (Deployment Workflow Principles)

### 5 阶段流程

```
1. 准备 (PREPARE)
   └── 验证代码、构建、环境变量

2. 备份 (BACKUP)
   └── 在变更前保存当前状态

3. 部署 (DEPLOY)
   └── 执行，同时保持监控开启

4. 验证 (VERIFY)
   └── 健康检查、日志、关键流程

5. 确认或回滚 (CONFIRM or ROLLBACK)
   └── 一切正常？确认。有问题？回滚。
```

### 阶段原则

| 阶段     | 原则                   |
| -------- | ---------------------- |
| **准备** | 绝不部署未经测试的代码 |
| **备份** | 没有备份就无法回滚     |
| **部署** | 看着它发生，不要走开   |
| **验证** | 信任但要验证           |
| **确认** | 准备好回滚触发器       |

---

## 4. 部署后验证 (Post-Deployment Verification)

### 验证什么

| 检查             | 原因             |
| ---------------- | ---------------- |
| **健康端点**     | 服务正在运行     |
| **错误日志**     | 无新错误         |
| **关键用户流程** | 关键功能正常工作 |
| **性能**         | 响应时间可接受   |

### 验证窗口

- **前 5 分钟**: 主动监控
- **15 分钟**: 确认稳定
- **1 小时**: 最终验证
- **次日**: 审查指标

---

## 5. 回滚原则 (Rollback Principles)

### 何时回滚

| 症状          | 行动                     |
| ------------- | ------------------------ |
| 服务宕机      | 立即回滚                 |
| 严重错误      | 回滚                     |
| 性能下降 >50% | 考虑回滚                 |
| 次要问题      | 如果能快速修复则向前修复 |

### 平台回滚策略

| 平台               | 回滚方法              |
| ------------------ | --------------------- |
| **Vercel/Netlify** | 重新部署上一个 commit |
| **Railway/Render** | 仪表盘回滚            |
| **VPS + PM2**      | 恢复备份，重启        |
| **Docker**         | 上一个镜像标签        |
| **K8s**            | kubectl rollout undo  |

### 回滚原则

1. **速度优于完美**: 先回滚，后调试
2. **不要叠加错误**: 一次回滚，不要多次变更
3. **沟通**: 告诉团队发生了什么
4. **事后复盘**: 稳定后了解原因

---

## 6. 零停机部署 (Zero-Downtime Deployment)

### 策略

| 策略                  | 原理               |
| --------------------- | ------------------ |
| **滚动 (Rolling)**    | 逐个替换实例       |
| **蓝绿 (Blue-Green)** | 在环境之间切换流量 |
| **金丝雀 (Canary)**   | 逐步流量切换       |

### 选择原则

| 场景       | 策略                  |
| ---------- | --------------------- |
| 标准发布   | 滚动                  |
| 高风险变更 | 蓝绿 (易于回滚)       |
| 需要验证   | 金丝雀 (真实流量测试) |

---

## 7. 紧急程序 (Emergency Procedures)

### 服务宕机优先级

1. **评估**: 症状是什么？
2. **快速修复**: 如果不清楚则重启
3. **回滚**: 如果重启无效
4. **调查**: 稳定之后

### 调查顺序

| 检查     | 常见问题     |
| -------- | ------------ |
| **日志** | 错误，异常   |
| **资源** | 磁盘满，内存 |
| **网络** | DNS，防火墙  |
| **依赖** | 数据库，API  |

---

## 8. 反模式 (Anti-Patterns)

| ❌ 不要        | ✅ 要            |
| -------------- | ---------------- |
| 周五部署       | 本周早些时候部署 |
| 匆忙部署       | 遵循流程         |
| 跳过预发布环境 | 始终先测试       |
| 无备份部署     | 部署前备份       |
| 部署后走开     | 监控 15+ 分钟    |
| 一次多个变更   | 一次一个变更     |

---

## 9. 决策检查清单 (Decision Checklist)

部署前：

- [ ] **流程适合平台？**
- [ ] **备份策略已就绪？**
- [ ] **回滚计划已文档化？**
- [ ] **监控已配置？**
- [ ] **已通知团队？**
- [ ] **之后有时间监控？**

---

## 10. 最佳实践 (Best Practices)

1. **小而频繁的部署** 优于大版本发布
2. **特性开关 (Feature flags)** 用于风险变更
3. **自动化** 重复步骤
4. **文档化** 每次部署
5. **复盘** 问题后的原因
6. **测试回滚** 在需要之前

---

> **记住：** 每次部署都是风险。通过准备来最小化风险，而不是速度。
