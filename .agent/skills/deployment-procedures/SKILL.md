---
name: deployment-procedures
description: Production deployment principles and decision-making. Safe deployment workflows, rollback strategies, and verification. Teaches thinking, not scripts.
allowed-tools: Read, Glob, Grep, Bash
---

# 部署流程

> 生产环境发布部署的原则与决策。包括安全部署工作流、回滚策略和验证机制。
> **学会思考，而不是死记硬背脚本。**

---

## ⚠️ 如何使用此技能

本技能教授的是 **部署原则**，而非可以直接复制的 Bash 脚本。

- 每次部署都是独一无二的
- 理解每一步背后的“为什么”
- 根据你的平台调整流程

---

## 1. 平台选择

### 决策树

```
你要部署什么？
│
├── 静态网站 / JAMstack
│   └── Vercel, Netlify, Cloudflare Pages
│
├── 简单 Web 应用
│   ├── 全托管 (Managed) → Railway, Render, Fly.io
│   └── 自控 (Control) → VPS + PM2/Docker
│
├── 微服务
│   └── 容器编排 (Container orchestration)
│
└── 无服务器 (Serverless)
    └── Edge functions, Lambda
```

### 每个平台都有不同的流程

| 平台               | 部署方法           |
| ------------------ | ------------------ |
| **Vercel/Netlify** | Git push, 自动部署 |
| **Railway/Render** | Git push 或 CLI    |
| **VPS + PM2**      | SSH + 手动步骤     |
| **Docker**         | 镜像推送 + 编排    |
| **Kubernetes**     | kubectl apply      |

---

## 2. 部署前原则

### 4 大验证类别

| 类别                   | 检查内容                          |
| ---------------------- | --------------------------------- |
| **代码质量**           | 测试通过、Lint 无报错、已代码审查 |
| **构建 (Build)**       | 生产构建成功、无警告              |
| **环境 (Environment)** | 环境变量已设置、密钥是最新的      |
| **安全 (Safety)**      | 备份已完成、回滚计划已就绪        |

### 部署前检查清单

- [ ] 所有测试已通过
- [ ] 代码已审查并批准
- [ ] 生产构建成功
- [ ] 环境变量已验证
- [ ] 数据库迁移已就绪 (如果适用)
- [ ] 回滚计划已记录
- [ ] 团队已通知
- [ ] 监控已就绪

---

## 3. 部署工作流原则

### 5 阶段流程

```
1. 准备 (PREPARE)
   └── 验证代码、构建、环境变量

2. 备份 (BACKUP)
   └── 在变更前保存当前状态

3. 部署 (DEPLOY)
   └── 执行部署，保持监控开启

4. 验证 (VERIFY)
   └── 健康检查、日志、关键流程

5. 确认或回滚 (CONFIRM or ROLLBACK)
   └── 一切正常？确认。有问题？回滚。
```

### 阶段原则

| 阶段               | 原则                   |
| ------------------ | ---------------------- |
| **准备 (Prepare)** | 绝不部署未经测试的代码 |
| **备份 (Backup)**  | 没有备份就无法回滚     |
| **部署 (Deploy)**  | 看着它发生，不要走开   |
| **验证 (Verify)**  | 信任但要验证           |
| **确认 (Confirm)** | 准备好回滚触发器       |

---

## 4. 部署后验证

### 验证什么

| 检查项                         | 原因                   |
| ------------------------------ | ---------------------- |
| **健康端点 (Health endpoint)** | 服务正在运行           |
| **错误日志**                   | 无新增错误             |
| **关键用户流程**               | 核心功能正常工作       |
| **性能**                       | 响应时间在可接受范围内 |

### 验证窗口

- **前 5 分钟**: 活跃监控
- **15 分钟**: 确认稳定
- **1 小时**: 最终验证
- **次日**: 审查指标

---

## 5. 回滚原则

### 何时回滚

| 症状          | 行动                                   |
| ------------- | -------------------------------------- |
| 服务宕机      | 立即回滚                               |
| 关键错误      | 回滚                                   |
| 性能下降 >50% | 考虑回滚                               |
| 轻微问题      | 如果能快速修复则向前修复 (Fix forward) |

### 各平台的回滚策略

| 平台               | 回滚方法              |
| ------------------ | --------------------- |
| **Vercel/Netlify** | 重新部署上一个 commit |
| **Railway/Render** | 在仪表盘中回滚        |
| **VPS + PM2**      | 恢复备份并重启        |
| **Docker**         | 使用上一个镜像 tag    |
| **K8s**            | kubectl rollout undo  |

### 回滚原则

1. **速度优于完美**: 先回滚，后调试
2. **不要叠加错误**: 只做一次回滚，不要做多次变更
3. **沟通**: 告诉团队发生了什么
4. **事后总结**: 稳定后分析原因

---

## 6. 零停机部署

### 策略

| 策略                  | 工作原理           |
| --------------------- | ------------------ |
| **滚动 (Rolling)**    | 逐个替换实例       |
| **蓝绿 (Blue-Green)** | 在环境之间切换流量 |
| **金丝雀 (Canary)**   | 逐渐转移流量       |

### 选择原则

| 场景       | 策略                    |
| ---------- | ----------------------- |
| 标准发布   | 滚动                    |
| 高风险变更 | 蓝绿 (易于回滚)         |
| 需要验证   | 金丝雀 (用真实流量测试) |

---

## 7. 紧急程序

### 服务宕机优先级

1. **评估**: 症状是什么？
2. **快速修复**: 如果不清楚，重启
3. **回滚**: 如果重启无效
4. **调查**: 稳定之后

### 调查顺序

| 检查                    | 常见问题           |
| ----------------------- | ------------------ |
| **日志 (Logs)**         | 错误、异常         |
| **资源 (Resources)**    | 磁盘满了、内存不足 |
| **网络 (Network)**      | DNS, 防火墙        |
| **依赖 (Dependencies)** | 数据库、API        |

---

## 8. 反模式

| ❌ 不要 (Don't)          | ✅ 要 (Do)       |
| ------------------------ | ---------------- |
| 周五部署                 | 在周初部署       |
| 匆忙部署                 | 遵循流程         |
| 跳过预发布环境 (Staging) | 始终先测试       |
| 无备份部署               | 部署前备份       |
| 部署后走人               | 监控 15 分钟以上 |
| 一次性做多个变更         | 一次只做一个变更 |

---

## 9. 决策检查清单

在部署之前：

- [ ] **流程是否适合当前平台？**
- [ ] **备份策略是否就绪？**
- [ ] **回滚计划是否已记录？**
- [ ] **监控是否已配置？**
- [ ] **团队是否已通知？**
- [ ] **是否有时间在部署后监控？**

---

## 10. 最佳实践

1. **小而频繁的部署** 优于大版本发布
2. **特性开关 (Feature flags)** 用于风险变更
3. **自动化** 重复步骤
4. **记录/文档化** 每次部署
5. **复盘** 问题发生后的原因
6. **测试回滚** 在你需要它之前

> **记住：** 每次部署都有风险。通过准备来降低风险，而不是靠速度。
