---
name: performance-profiling
description: 性能分析原则。测量、分析与优化技术。
allowed-tools: Read, Glob, Grep, Bash
---

# 性能分析 (Performance Profiling)

> 测量、分析、优化 —— 依序进行。

---

## 🔧 运行脚本 (Runtime Scripts)

**执行这些脚本进行自动化分析：**

| 脚本                          | 用途                | 用法                                                     |
| ----------------------------- | ------------------- | -------------------------------------------------------- |
| `scripts/lighthouse_audit.py` | Lighthouse 性能审计 | `python scripts/lighthouse_audit.py https://example.com` |

---

## 1. 核心 Web 指标 (Core Web Vitals)

### 目标 (Targets)

| 指标    | 优秀 (Good) | 较差 (Poor) | 衡量维度   |
| ------- | ----------- | ----------- | ---------- |
| **LCP** | < 2.5s      | > 4.0s      | 加载速度   |
| **INP** | < 200ms     | > 500ms     | 交互性     |
| **CLS** | < 0.1       | > 0.25      | 视觉稳定性 |

### 何时测量

| 阶段               | 工具                |
| ------------------ | ------------------- |
| 开发 (Development) | 本地 Lighthouse     |
| CI/CD              | Lighthouse CI       |
| 生产 (Production)  | RUM（真实用户监控） |

---

## 2. 分析工作流 (Profiling Workflow)

### 4 步流程

```
1. 基准测试 (BASELINE) → 测量当前状态
2. 识别 (IDENTIFY) → 找到瓶颈
3. 修复 (FIX) → 进行针对性修改
4. 验证 (VALIDATE) → 确认改进效果
```

### 分析工具选择

| 问题     | 工具                                   |
| -------- | -------------------------------------- |
| 页面加载 | Lighthouse                             |
| 包体积   | 包分析器 (Bundle analyzer)             |
| 运行时   | 开发者工具 (DevTools) Performance 面板 |
| 内存     | DevTools Memory 面板                   |
| 网络     | DevTools Network 面板                  |

---

## 3. 包分析 (Bundle Analysis)

### 关注点 (What to Look For)

| 问题       | 迹象                       |
| ---------- | -------------------------- |
| 大型依赖   | 位于包的顶部               |
| 重复代码   | 存在于多个分片 (Chunks) 中 |
| 未使用代码 | 覆盖率低                   |
| 缺失分片   | 单个巨大的分片             |

### 优化行动

| 发现         | 行动                    |
| ------------ | ----------------------- |
| 大型库       | 仅导入特定模块          |
| 重复依赖     | 去重 (Dedupe)，更新版本 |
| 主包中的路由 | 代码分割 (Code split)   |
| 未使用的导出 | 摇树优化 (Tree shake)   |

---

## 4. 运行时分析 (Runtime Profiling)

### Performance 面板分析

| 模式                     | 含义               |
| ------------------------ | ------------------ |
| 长任务 (>50ms)           | UI 阻塞            |
| 许多小任务               | 可能存在批处理机会 |
| 布局/绘制 (Layout/paint) | 渲染瓶颈           |
| 脚本 (Script)            | JavaScript 执行    |

### 内存面板分析

| 模式           | 含义             |
| -------------- | ---------------- |
| 堆 (Heap) 增长 | 可能存在内存泄漏 |
| 大型保留内存   | 检查引用         |
| 分离的 DOM     | 未被清理         |

---

## 5. 常见瓶颈

### 按症状分类 (By Symptom)

| 症状            | 可能原因                    |
| --------------- | --------------------------- |
| 初始加载慢      | JavaScript 过大，渲染阻塞   |
| 交互慢          | 事件处理器过重              |
| 滚动卡顿 (Jank) | 布局抖动 (Layout thrashing) |
| 内存增长        | 泄漏，保留的引用            |

---

## 6. 快速见效优先级 (Quick Win Priorities)

| 优先级 | 行动         | 影响 |
| ------ | ------------ | ---- |
| 1      | 启用压缩     | 高   |
| 2      | 图片懒加载   | 高   |
| 3      | 路由代码分割 | 高   |
| 4      | 缓存静态资源 | 中   |
| 5      | 优化图片     | 中   |

---

## 7. 反模式 (Anti-Patterns)

| ❌ 不要 (Don't) | ✅ 要 (Do)     |
| --------------- | -------------- |
| 凭空猜测问题    | 先进行性能分析 |
| 进行微优化      | 修复最大的问题 |
| 过早优化        | 在需要时再优化 |
| 忽视真实用户    | 使用 RUM 数据  |

---

> **记住：** 最快的代码是那些不运行的代码。优化之前，先尝试删除。
