---
description: 逐份修复 Markdown 文档漂移：先还原上游原文，再做语义汉化，最后做 Antigravity/Codex 兼容微调。
---

# /restore-localize-compat - 文档机制对齐流程

$ARGUMENTS

---

## 目标

用于处理“本地文档与上游文档差异过大，已破坏原有机制”的场景。

核心目标：

1. **先还原机制**：以 `reference/antigravity-kit` 为唯一机制基线。
2. **再汉化语义**：仅翻译自然语言，不改处理逻辑。
3. **后做兼容微调**：仅在必要时补充 Antigravity 与 Codex 的兼容说明。

---

## 背景与问题来源

本仓库是基于上游 Antigravity 项目进行汉化与扩展的分支，并新增了 Codex 适配能力。

在历史迭代中，部分 Markdown 文档出现了以下问题：

1. 与上游文档结构和机制发生较大偏离（章节顺序、执行步骤、约束描述被改写）。
2. 混入了非功能性说明，导致功能文档可执行性下降。
3. 个别文档只做了“文本改写”，但未保持与上游脚本和流程的对应关系。

这会带来两个直接风险：

1. Antigravity 主机制被误导，行为与上游预期不一致。
2. Codex 兼容适配建立在漂移文档之上，后续维护成本和回归风险显著上升。

因此本流程采用固定顺序：

1. 先恢复上游机制基线。
2. 再进行语义汉化。
3. 最后仅做必要的兼容微调。

---

## 适用范围

- `.agent/**/*.md`
- `docs/**/*.md`
- 根目录功能文档（如 `README.md`、`AGENT_FLOW.md`、`CHANGELOG.md` 等）

优先级建议：

1. `.agent/skills/**/SKILL.md`
2. `.agent/agents/*.md`
3. `.agent/workflows/*.md`
4. 其他功能与运维文档

---

## 硬性约束（必须遵守）

1. **禁止脚本批量改写文档内容**（可使用检索命令定位，但修改必须逐份人工完成）。
2. **每次只处理 1 份文档**，完成后立即提交并推送。
3. **不得改机制**：不得删除/新增上游机制步骤、命令、参数语义、脚本调用关系。
4. **非功能性说明不得进入功能文档**（如宣传语、个人化样例、无关解释）。
5. **保留通用英文专有名词**（见下方术语表）。

---

## 红线禁令（违反即失败）

以下任一行为出现，视为该文件处理失败，必须整份返工：

1. **摘要化/改写化**：把上游原文“概括成短文”或“重写成另一套结构”。
2. **删节机制内容**：删除章节、删除流程步骤、删除命令示例、删除脚本引用。
3. **结构重排**：改变标题层级、段落顺序、列表结构、代码块位置。
4. **改动机制文本**：擅自修改命令、参数、路径、占位符、Frontmatter key。
5. **无依据兼容改动**：未给出冲突依据就加入“兼容说明”或“额外机制”。

重点强调：

- **禁止把 100 行上游机制压缩成 30 行“精简版”**。
- **禁止“优化可读性”为理由删掉上游的规则细节**。
- **拿不准时保留原样，不要自作主张重写**。

---

## 常见违规示例对照表（必须对照执行）

### 示例 1：摘要化改写（禁止）

错误写法（违规）：

- 上游原文有完整 8 个章节，本地改成“3 段总结 + 若干建议”。

正确写法（合规）：

- 保留上游全部章节结构，仅把自然语言翻译为中文。

### 示例 2：删除机制步骤（禁止）

错误写法（违规）：

- 删掉上游的 “Testing the System / Edge Cases / Integration with Existing Workflows” 等章节。

正确写法（合规）：

- 这些章节必须全部保留；若需补充说明，只能在不改变原意的前提下最小补充。

### 示例 3：命令与参数被汉化或改写（禁止）

错误写法（违规）：

- 把 `--target`、`--fix`、`ag-kit update` 改成中文描述或替代命令。

正确写法（合规）：

- 命令、参数、路径、占位符保持原样；只翻译解释文本。

### 示例 3.1：示例命令中的提示词未翻译（禁止）

错误写法（违规）：

- 保留英文提示词：`python scripts/search.py "fintech crypto" --design-system`

正确写法（合规）：

- 仅翻译提示词语义，命令结构不变：`python scripts/search.py "金融 科技 加密" --design-system`
- 或：`python scripts/search.py "为金融科技产品生成设计系统关键词" --design-system`

### 示例 4：代码块“优化重排”（禁止）

错误写法（违规）：

- 把上游多个代码块合并成一个，或移动到其他章节。

正确写法（合规）：

- 代码块数量和位置与上游保持一致，仅允许代码块外文字语义汉化。

### 示例 5：无依据兼容说明（禁止）

错误写法（违规）：

- 直接新增“为 Codex 优化”段落，但未说明冲突来源与依据。

正确写法（合规）：

- 必须先给出冲突点、依据来源、最小改动理由，再做兼容微调。

### 示例 6：非功能性内容混入（禁止）

错误写法（违规）：

- 在功能文档加入宣传语、感谢语、个人化文案、无关解释。

正确写法（合规）：

- 功能文档仅保留机制与执行信息；非功能性内容放到 README 等合适位置。

---

## 术语保留与双语标注规则

针对“英文专用/通用名称”，执行以下规则：

1. **原名保留**：英文原名必须保留，不得强行替换为纯中文。
2. **首次双语**：同一文档内首次出现时，使用 `English（中文）` 格式。
3. **后续一致**：后续可使用 `English` 或 `English（中文）`，但全篇保持一致，不得混乱切换。
4. **机制文本例外**：命令、参数、路径、占位符、Frontmatter key 一律保持原样，不追加中文到代码/命令本体中。
5. **示例命令中的提示词需汉化**：若命令参数中包含自然语言提示词（prompt/query），该提示词需做语义中文翻译。
6. **禁止反向格式**：避免把术语写成“中文（English）”作为主格式，默认以英文原名为主。

推荐术语首现写法示例：

- Antigravity（反重力框架）
- Codex（代码智能体环境）
- Agent（智能体）
- Skill（技能）
- Workflow（工作流）
- Rule（规则）
- MCP（模型上下文协议）
- CLI（命令行界面）
- Frontmatter（文档头元数据）
- Schema（模式定义）
- API（应用程序接口）/ SDK（软件开发工具包）
- URL（统一资源定位符）
- path（路径）

---

## 三阶段执行流程（逐文件）

### Phase 1：还原上游原文（先还原）

对当前处理文件 `<file>`：

1. 找到上游对照文件：`reference/antigravity-kit/<file>`。
2. 先把本地内容恢复为上游结构与机制（章节、顺序、命令、参数、脚本路径保持一致）。
3. 确认未引入“上游补充说明”“reference 对齐提示”等后加段落。

仅用于核对的命令示例（可用）：

```bash
diff -u reference/antigravity-kit/<file> <file>
```

### Phase 2：语义汉化（不改机制）

在 Phase 1 基础上做语义翻译，规则如下：

1. 只翻译自然语言说明。
2. 保持以下内容原样：
   - 代码块内容
   - 命令与参数（如 `--target`、`--fix`）
   - 文件名与路径（如 `.agent/`、`SKILL.md`）
   - 占位符（如 `$ARGUMENTS`）
   - Frontmatter key（如 `description`）
3. 标题层级、段落顺序、列表结构不变。

### Phase 3：兼容微调（必要才做）

仅在出现真实冲突时微调：

1. **Antigravity 基线**：保留其官方机制与触发方式，不改默认工作流语义。
2. **Codex 兼容**：仅补充与本仓库适配层直接相关的信息（如 `.agents`、映射与托管规则）。
3. 微调应为最小改动，且不能反向破坏上游机制。

兼容微调的触发门槛（必须同时满足）：

1. 明确写出冲突点（哪一段与哪个运行规则冲突）。
2. 明确写出依据（对应官方规则或本仓库既有机制）。
3. 明确写出最小改动说明（为何不能零改动解决）。

---

## 验收清单（每份文档都要过）

1. 与上游对比后，机制性元素一致（章节流程、命令、参数、脚本引用不漂移）。
2. 仅语言层发生变化，不出现逻辑重写。
3. 无非功能性说明残留。
4. 术语保留符合规则。
5. 文档中的路径、命令、文件引用可执行或可解析。

强制通过项（缺一不可）：

1. 标题层级数量与上游一致（`#` 到 `####`）。
2. 代码块数量与上游一致。
3. 机制关键字不丢失（命令、参数、脚本名、路径、工作流触发词）。
4. 不允许出现“本地新增解释覆盖上游原意”的段落。
5. 示例命令中若包含自然语言提示词，提示词已完成语义汉化（仅提示词翻译，命令结构不变）。

---

## 提交前人工核查（强制执行）

以下命令仅用于核查，允许使用：

```bash
# 1) 人工查看差异（逐段确认是否仅为语义汉化）
diff -u reference/antigravity-kit/<file> <file>

# 2) 快速核对标题结构数量
rg -n '^#{1,4} ' reference/antigravity-kit/<file>
rg -n '^#{1,4} ' <file>

# 3) 快速核对命令/参数/路径 token
rg -n 'ag-kit|python|--target|--fix|--path|--no-index|\\.agent/|\\.agents/|SKILL\\.md|AGENTS\\.md|antigravity\\.rules' <file>
```

人工核查口径：

1. 如果发现“少段落/少章节/少代码块”，立即返工，不得提交。
2. 如果发现“机制 token 丢失”，立即返工，不得提交。
3. 如果发现“新增机制说明”，必须提供依据，否则返工。

---

## 返工规则（必须执行）

1. 任一红线命中：整份文档回到 Phase 1 重做。
2. 验收清单未全过：禁止 `git commit`。
3. 未附处理报告：禁止进入下一份文档。

---

## 提交流程（强制）

每处理完 1 份文档，立刻执行：

```bash
git add <file>
git commit -m "docs: 对齐上游机制并语义汉化 <file>"
git push
```

然后再处理下一份文档。

---

## 建议报告模板（给编排者）

```markdown
## 文档处理报告

- 文件：`<file>`
- 结果：完成 / 阻塞
- 上游对照：`reference/antigravity-kit/<file>`
- 机制修复点：
  1. ...
  2. ...
- 汉化说明：
  1. ...
  2. ...
- 兼容微调：
  1. ...
- 结构核查：
  1. 标题层级数量（local/ref）：...
  2. 代码块数量（local/ref）：...
  3. 关键 token 核查：通过 / 不通过
- 提交记录：`<commit-sha>`
```
