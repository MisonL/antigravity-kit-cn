class RuleGenerator {
    /**
     * Generate content for AGENTS.md, antigravity.rules and codex.json
     * @param {object} transformResult Result from Transformer
     * @returns {object} { agentsMd: string, antigravityRules: string, codexJson: object }
     */
    static generate(transformResult, version = "1.0.0") {
        const { metadata } = transformResult;
        
        // 1. Generate codex.json
        const codexJson = {
            version: version,
            updatedAt: new Date().toISOString(),
            skills: metadata.map(m => ({
                id: m.id,
                originalName: m.originalName,
                path: m.path
            }))
        };

        // 2. Generate AGENTS.md managed section content
        let agentsMd = `# AI Agent Capabilities (Codex Managed)\n\n`;
        agentsMd += `> **Auto-generated by Antigravity Kit (Codex)**\n`;
        agentsMd += `> Version: ${version}\n\n`;
        
        agentsMd += `## Available Skills\n\n`;
        
        for (const meta of metadata) {
            agentsMd += `- **${meta.id}** (${meta.type})\n`;
            agentsMd += `  - Path: \`${meta.path}\`\n`;
        }
        
        agentsMd += `\n## Usage Rules\n\n`;
        agentsMd += `1. Managed resources are synchronized under \`.agents/skills\`.\n`;
        agentsMd += `2. Do not rename managed skill folders manually.\n`;
        agentsMd += `3. Use \`ag-kit doctor --target codex --fix\` to recover missing managed artifacts.\n`;

        // 3. Generate risk controls
        let antigravityRules = `# Antigravity Risk Controls (Codex Managed)\n\n`;
        antigravityRules += `version: ${version}\n`;
        antigravityRules += `generated_at: ${new Date().toISOString()}\n\n`;
        antigravityRules += `## Controls\n`;
        antigravityRules += `- Managed skills are stored under \`.agents/skills\`.\n`;
        antigravityRules += `- Keep generated skill IDs stable to avoid selector drift.\n`;
        antigravityRules += `- If integrity checks fail, run \`ag-kit doctor --target codex --fix\`.\n`;
        antigravityRules += `- Before destructive updates, preserve manual edits in source control.\n`;

        return {
            agentsMd,
            antigravityRules,
            codexJson
        };
    }
}

module.exports = RuleGenerator;
